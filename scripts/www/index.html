<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=3.0, user-scalable=yes">
    <title>ç™¾å®¶æ¨‚å¤šè·¯å–®æ™ºèƒ½åˆ†æç³»çµ±</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* æ ¹æ“šè¢å¹•å¯¬åº¦è‡ªå‹•èª¿æ•´æ ¹å­—é«”å¤§å° */
        html {
            font-size: 16px; /* é è¨­åŸºæº– */
        }

        /* æ¥µå°è¢å¹• (â‰¤360px) */
        @media (max-width: 360px) {
            html {
                font-size: 12px;
            }
        }

        /* å°è¢å¹• (361px-480px) */
        @media (min-width: 361px) and (max-width: 480px) {
            html {
                font-size: 13px;
            }
        }

        /* ä¸­ç­‰è¢å¹• (481px-768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            html {
                font-size: 14px;
            }
        }

        /* å¤§è¢å¹• (769px-1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            html {
                font-size: 15px;
            }
        }

        /* è¶…å¤§è¢å¹• (>1024px) */
        @media (min-width: 1025px) {
            html {
                font-size: 16px;
            }
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #e9ecef;
            padding: 0.625rem; /* ä½¿ç”¨ rem å–®ä½è‡ªå‹•ç¸®æ”¾ */
        }

        /* ===== æ¿€æ´»ç•Œé¢æ¨£å¼ ===== */
        #activationScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        .activation-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px 30px;
            max-width: 500px;
            width: 100%;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .activation-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .activation-header h1 {
            color: #667eea;
            font-size: 26px;
            margin-bottom: 8px;
        }

        .activation-header p {
            color: #888;
            font-size: 14px;
        }

        .activation-info-box {
            background: #e8f4ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
            color: #333;
        }

        .activation-group {
            margin-bottom: 25px;
        }

        .activation-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .device-id-display {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 16px;
            text-align: center;
            color: #667eea;
            font-weight: bold;
            letter-spacing: 2px;
            word-break: break-all;
            position: relative;
        }

        .copy-device-id-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .copy-device-id-btn:hover {
            background: #5568d3;
        }

        .activation-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            transition: all 0.3s;
        }

        .activation-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .activation-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .activation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .activation-btn:active {
            transform: translateY(0);
        }

        .activation-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            color: #888;
            font-size: 12px;
        }

        .activation-error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid #ef5350;
            animation: shake 0.5s;
        }

        .activation-success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid #66bb6a;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 15px 5px rgba(255, 107, 107, 0.3);
            }
        }

        #mainApp {
            display: none;
        }

        .activated #mainApp {
            display: block;
        }

        .activated #activationScreen {
            display: none;
        }

        @media (max-width: 600px) {
            .activation-container {
                padding: 30px 20px;
            }

            .activation-header h1 {
                font-size: 22px;
            }

            .device-id-display {
                font-size: 14px;
                padding: 12px;
            }

            .copy-device-id-btn {
                position: static;
                transform: none;
                width: 100%;
                margin-top: 10px;
            }
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* é é¦– */
        .header {
            background: white;
            padding: 0.9375rem; /* 15px */
            margin-bottom: 0.625rem; /* 10px */
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.625rem; /* 10px */
            margin-bottom: 0.625rem; /* 10px */
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* 8px */
            padding: 0.5rem 0.9375rem; /* 8px 15px */
            background: #667eea;
            color: white;
            border-radius: 0.375rem; /* 6px */
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem; /* 8px */
        }

        .header-btn {
            padding: 0.5rem 0.9375rem; /* 8px 15px */
            border: none;
            border-radius: 0.375rem; /* 6px */
            font-size: 0.8125rem; /* 13px */
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.3125rem; /* 5px */
        }

        .btn-home {
            background: #3498db;
            color: white;
        }

        .btn-logout {
            background: #e74c3c;
            color: white;
        }

        .header-title {
            text-align: center;
        }

        .header-title h1 {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        /* è¼¸å…¥å€ */
        .input-section {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* æ¡Œé¢ç‰ˆ: æŒ‰éˆ•æ’æˆä¸€æ’ */
        .input-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.625rem 1.25rem; /* 10px 20px */
            border: none;
            border-radius: 0.375rem; /* 6px */
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            cursor: pointer;
            color: white;
            white-space: nowrap;
            min-height: 2.75rem; /* 44px - è§¸æ§å‹å–„ */
        }

        .btn-banker {
            background: #dc3545;
        }

        .btn-player {
            background: #0d6efd;
        }

        .btn-undo {
            background: #ffc107;
        }

        .btn-analyze {
            background: #28a745;
        }

        .btn-clear {
            background: #6c757d;
        }

        .btn-random {
            background: #6f42c1;
        }

        .btn-chart {
            background: #17a2b8;
        }

        .random-group {
            display: flex;
            gap: 0.625rem; /* 10px */
            align-items: center;
        }

        .random-inputs {
            display: flex;
            gap: 0.5rem; /* 8px */
            align-items: center;
            flex-wrap: wrap;
        }

        .random-input {
            width: 3.75rem; /* 60px */
            padding: 0.5rem; /* 8px */
            border: 1px solid #ced4da;
            border-radius: 0.375rem; /* 6px */
            font-size: 0.875rem; /* 14px */
            text-align: center;
        }

        .random-label {
            font-size: 0.75rem; /* 12px */
            color: #6c757d;
            white-space: nowrap;
        }

        textarea {
            width: 100%;
            min-height: 3.75rem; /* 60px */
            padding: 0.625rem; /* 10px */
            border: 1px solid #ced4da;
            border-radius: 0.375rem; /* 6px */
            font-size: 0.875rem; /* 14px */
            margin-bottom: 0.625rem; /* 10px */
            font-family: monospace;
        }

        /* æ‰‹æ©Ÿå’Œå¹³æ¿: å›ºå®šåœ¨åº•éƒ¨ */
        @media (max-width: 1024px) {
            body {
                padding-bottom: 160px; /* ç‚ºå›ºå®šåº•éƒ¨ç•™å‡ºç©ºé–“ */
                overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
            }

            .input-section {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                margin: 0;
                border-radius: 0;
                z-index: 1000;
                padding: 8px;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
                width: 100%;
                box-sizing: border-box;
                overflow-x: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
            }

            .input-controls {
                display: flex;
                gap: 4px;
                margin-bottom: 8px;
                flex-wrap: wrap;
                width: 100%;
            }

            .btn {
                padding: 8px 6px;
                font-size: 12px;
                flex: 1 1 0;
                min-width: 0; /* å…è¨±æŒ‰éˆ•ç¸®å° */
                max-width: none;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* æ‰‹æ©Ÿç‰ˆ:èŠå’Œé–’æŒ‰éˆ•åŠ é•·(åˆ†é…åŸè¨ˆç®—æŒ‰éˆ•çš„ç©ºé–“) */
            .btn-banker,
            .btn-player {
                flex: 1.5 1 0; /* æ¯”å…¶ä»–æŒ‰éˆ•å¯¬ 50% */
            }

            .btn i {
                display: none; /* æ‰‹æ©Ÿç‰ˆéš±è—åœ–æ¨™ç¯€çœç©ºé–“ */
            }

            .random-group {
                width: 100%;
                display: block; /* æ”¹ç‚º block */
                margin: 0;
                padding: 0;
            }

            .btn-random {
                flex: 0 0 auto;
                padding: 6px 8px;
                font-size: 11px;
                white-space: nowrap;
                margin: 0;
                margin-right: 4px;
            }

            .random-inputs {
                display: flex;
                gap: 3px;
                align-items: center;
                flex-wrap: wrap;
                width: 100%;
            }

            .random-input {
                width: 40px;
                padding: 5px 2px;
                font-size: 11px;
                text-align: center;
                box-sizing: border-box;
            }

            .random-label {
                font-size: 10px;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            /* ç‰¹å®šè¼¸å…¥æ¡†å¯¬åº¦èª¿æ•´ */
            #jumpRatioThreshold,
            #winRateThreshold {
                width: 38px;
            }
            
            /* æ‰‹æ©Ÿç‰ˆ label å’Œå‹¾é¸æ¡†å„ªåŒ– */
            .random-inputs label {
                display: inline-flex !important;
                align-items: center;
                gap: 3px !important;
                margin-left: 5px !important;
                white-space: nowrap;
            }
            
            .random-inputs input[type="checkbox"],
            .random-inputs input[type="radio"] {
                width: auto;
                margin: 0;
                padding: 0;
            }
            
            /* AI æ¨¡å¼ç¨ç«‹ä¸€æ’ */
            .ai-mode-row {
                display: flex;
                align-items: center;
                gap: 3px;
                flex-wrap: wrap;
                width: 100%;
                margin-top: 8px;
                padding-top: 8px;
                border-top: 1px solid #dee2e6; /* æ”¹ç‚ºè¼ƒæ·±çš„ç°è‰² */
            }
            
            .ai-mode-row label {
                display: inline-flex !important;
                align-items: center;
                gap: 3px !important;
                white-space: nowrap;
            }
            
            .ai-mode-row input[type="radio"] {
                width: auto;
                margin: 0;
                padding: 0;
            }

            textarea {
                min-height: 45px;
                font-size: 13px;
                margin-bottom: 8px;
                padding: 8px;
                width: 100%;
                box-sizing: border-box;
            }

            /* å¯æ‘ºç–Šå€åŸŸ - åªåœ¨æ‰‹æ©Ÿç‰ˆé¡¯ç¤º */
            .collapsible-toggle {
                width: 100%;
                padding: 5px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
                margin-top: 15px; /* èˆ‡ä¸Šæ–¹æŒ‰éˆ•ä¿æŒè·é›¢,é¿å…èª¤è§¸ */
                margin-bottom: 8px;
            }

            .collapsible-toggle:active {
                background: #5a6268;
            }

            .collapsible-content {
                display: none;
                width: 100%;
                text-align: left; /* å…§å®¹é å·¦ */
                padding: 0; /* ç§»é™¤å…§é‚Šè· */
            }

            .collapsible-content.show {
                display: block;
            }
        }

        /* å¹³æ¿: éš±è—é€²éšåŠŸèƒ½æŒ‰éˆ•ï¼Œç›´æ¥é¡¯ç¤ºå…§å®¹ */
        @media (min-width: 601px) and (max-width: 1024px) {
            .collapsible-toggle {
                display: none;
            }

            .collapsible-content {
                display: block !important;
            }
        }

        /* é›»è…¦ç‰ˆ: éš±è—é€²éšåŠŸèƒ½æŒ‰éˆ•ï¼Œç›´æ¥é¡¯ç¤ºå…§å®¹ */
        @media (min-width: 1025px) {
            .collapsible-toggle {
                display: none;
            }

            .collapsible-content {
                display: block !important;
            }
        }

        /* è·¯å–®ç¶²æ ¼ */
        .roads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 10px;
        }

        .road-card {
            background: white;
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .road-header {
            background: #f8f9fa;
            padding: 0.625rem 0.9375rem; /* 10px 15px */
            border-bottom: 0.125rem solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .road-name {
            font-size: 0.875rem; /* 14px */
            font-weight: 700;
            color: #212529;
        }

        .road-count {
            font-size: 0.75rem; /* 12px */
            color: #6c757d;
        }

        /* ç ç›¤è·¯é¡¯ç¤ºå€ - ä½¿ç”¨å›ºå®šåƒç´ ç¢ºä¿æ ¼å­å°é½Š */
        .bead-road {
            padding: 10px;
            background: white;
            min-height: 180px;
            overflow-x: auto;
        }

        .bead-grid {
            display: inline-grid;
            gap: 1px;
            background: #dee2e6;
            border: 1px solid #adb5bd;
        }

        .bead-cell {
            width: 26px;
            height: 26px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .grid-number {
            font-size: 9px;
            color: #6c757d;
            font-weight: 600;
            background: #f8f9fa;
        }

        .row-number {
            font-size: 9px;
            color: #6c757d;
            font-weight: 600;
            background: #f8f9fa;
        }

        .bead {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .bead-B {
            background: #dc3545;
        }

        .bead-P {
            background: #0d6efd;
        }

        /* çµ±è¨ˆè³‡è¨Š - ä½¿ç”¨å›ºå®šåƒç´ ç¢ºä¿å°é½Š */
        .road-stats {
            padding: 6px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-box {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .stat-box-row {
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 26px;
            border-bottom: 1px solid #dee2e6;
        }

        .stat-box-row:last-child {
            border-bottom: none;
        }

        .stat-header {
            font-size: 9px;
            font-weight: 700;
            color: #212529;
            padding: 4px 8px;
            white-space: nowrap;
            min-width: 130px;
            border-right: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            background: #f8f9fa;
        }

        .stat-info {
            font-size: 9px;
            color: #495057;
            line-height: 1.2;
            padding: 4px 8px;
            white-space: nowrap;
            flex: 1;
        }

        .stat-beads-container {
            padding: 6px;
            overflow-x: auto;
            background: white;
        }

        .stat-beads-grid {
            display: inline-grid;
            gap: 1px;
            background: #dee2e6;
            border: 1px solid #adb5bd;
        }

        .stat-bead-cell {
            width: 24px;
            height: 24px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-row-number {
            font-size: 8px;
            color: #6c757d;
            font-weight: 600;
            background: #f8f9fa;
            width: 18px;
        }

        .stat-bead {
            width: 18px;
            height: 18px;
            border-radius: 50%;
        }

        .stat-bead-hit {
            background: #dc3545;
        }

        .stat-bead-miss {
            background: #0d6efd;
        }

        /* é æ¸¬å€ */
        .prediction-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        .pred-box {
            border: 2px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .pred-header {
            padding: 6px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }

        .pred-follow {
            background: #28a745;
        }

        .pred-counter {
            background: #6f42c1;
        }

        .pred-content {
            padding: 8px;
            background: #f8f9fa;
        }

        .pred-result {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #212529;
            text-align: center;
        }

        .pred-beads-container {
            margin-bottom: 8px;
            padding: 5px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pred-beads-grid {
            display: inline-grid;
            gap: 2px;
        }

        .pred-bead-cell {
            width: 20px;
            height: 20px;
            background: white;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pred-bead {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .pred-bead-hit {
            background: #dc3545;
        }

        .pred-bead-miss {
            background: #0d6efd;
        }

        .pred-stats {
            font-size: 10px;
            color: #6c757d;
            text-align: center;
        }

        /* AIé æ¸¬å€ */
        .ai-prediction {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0.9375rem; /* 15px */
            margin-bottom: 0.625rem; /* 10px */
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 0.25rem 0.375rem rgba(0,0,0,0.1);
            color: white;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 0.625rem; /* 10px */
            margin-bottom: 0.75rem; /* 12px */
            font-size: 1.125rem; /* 18px */
            font-weight: 700;
        }

        .ai-content {
            background: rgba(255,255,255,0.15);
            border-radius: 0.375rem; /* 6px */
            padding: 0.75rem; /* 12px */
            backdrop-filter: blur(10px);
        }

        .ai-main-prediction {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.9375rem; /* 15px */
            margin-bottom: 0.75rem; /* 12px */
            padding: 0.9375rem; /* 15px */
            background: rgba(255,255,255,0.2);
            border-radius: 0.375rem; /* 6px */
        }

        .ai-label {
            font-size: 1rem; /* 16px */
            font-weight: 600;
        }

        .ai-result {
            font-size: 2rem; /* 32px */
            font-weight: 900;
            text-shadow: 0.125rem 0.125rem 0.25rem rgba(0,0,0,0.3);
            padding: 0.3125rem 1.25rem; /* 5px 20px */
            background: rgba(255,255,255,0.3);
            border-radius: 0.5rem; /* 8px */
        }

        .ai-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(12.5rem, 1fr)); /* 200px */
            gap: 0.5rem; /* 8px */
            margin-bottom: 0.625rem; /* 10px */
        }

        .ai-stat-item {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 0.75rem; /* 8px 12px */
            border-radius: 0.375rem; /* 6px */
            font-size: 0.8125rem; /* 13px */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-stat-label {
            font-weight: 600;
        }

        .ai-stat-value {
            font-weight: 700;
            font-size: 0.9375rem; /* 15px */
        }

        .ai-warnings {
            background: rgba(255,255,255,0.25);
            padding: 0.625rem; /* 10px */
            border-radius: 0.375rem; /* 6px */
            margin-top: 0.625rem; /* 10px */
        }

        .ai-warning-title {
            font-weight: 700;
            font-size: 0.875rem; /* 14px */
            margin-bottom: 0.5rem; /* 8px */
            display: flex;
            align-items: center;
            gap: 0.3125rem; /* 5px */
        }

        .ai-warning-list {
            display: flex;
            flex-direction: column;
            gap: 0.3125rem; /* 5px */
        }

        .ai-warning-item {
            background: rgba(255,255,255,0.3);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .warning-badge {
            background: #ff4757;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .roads-grid {
                grid-template-columns: 1fr;
            }

            .ai-prediction {
                margin-bottom: 10px;
            }

            .ai-main-prediction {
                padding: 12px;
                flex-direction: column !important;
                justify-content: center !important;
            }

            .ai-result {
                font-size: 28px;
            }

            .ai-stats-grid {
                grid-template-columns: 1fr;
            }
            
            /* æ‰‹æ©Ÿç‰ˆé‡æ³¨å»ºè­°ä½ç½®èª¿æ•´åˆ°å³ä¸Šè§’ */
            .heavy-bet-alert {
                position: absolute !important;
                right: 12px !important;
                top: 12px !important;
                margin-left: 0 !important;
                font-size: 12px !important;
                padding: 3px 10px !important;
            }
            
            .long-dragon-alert {
                position: absolute !important;
                right: 12px !important;
                top: 42px !important; /* æ”¾åœ¨é‡æ³¨æé†’ä¸‹æ–¹ */
                margin-left: 0 !important;
                font-size: 12px !important;
                padding: 3px 10px !important;
            }
            
            /* æ‰‹æ©Ÿç‰ˆç‰¹å®šèª¿æ•´ - rem å–®ä½æœƒè‡ªå‹•æ ¹æ“šè¢å¹•å¤§å°ç¸®æ”¾ */
            .ai-main-prediction {
                min-height: 5rem; /* ç¢ºä¿é›™æé†’æ™‚æœ‰è¶³å¤ ç©ºé–“ */
            }
        }

        @media (max-width: 1024px) {
            .ai-prediction {
                margin-bottom: 10px;
            }
        }

        /* æ›²ç·šåœ–æ¨¡æ…‹è¦–çª— */
        .chart-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow: auto;
        }

        .chart-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .chart-modal-header h2 {
            color: #333;
            font-size: 24px;
            margin: 0;
        }

        .chart-close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .chart-close:hover {
            color: #000;
        }

        .chart-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .chart-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid #ddd;
            transition: all 0.3s;
        }

        .chart-checkbox-label:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .chart-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .chart-canvas-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .btn-chart {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-chart:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .chart-data-table {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .chart-data-table h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .chart-data-table-wrapper {
            overflow-x: auto;
        }

        .chart-data-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .chart-data-table th,
        .chart-data-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
            white-space: nowrap;
        }

        .chart-data-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .chart-data-table tr:hover {
            background: #f8f9fa;
        }

        .result-b {
            color: #ff0000;
            font-weight: bold;
        }

        .result-p {
            color: #0066ff;
            font-weight: bold;
        }

        .mobile-only {
            display: none;
        }

        .desktop-only {
            display: inline;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: inline;
            }

            .desktop-only {
                display: none;
            }
            .chart-modal-content {
                width: 98%;
                padding: 10px;
                margin: 1% auto;
                max-height: 95vh;
            }

            .chart-modal-header {
                margin-bottom: 10px;
                padding-bottom: 10px;
            }

            .chart-modal-header h2 {
                font-size: 16px;
            }

            .chart-close {
                font-size: 28px;
            }

            .chart-options {
                gap: 6px;
                padding: 10px;
            }

            .chart-checkbox-label {
                font-size: 11px;
                padding: 5px 8px;
            }

            .chart-canvas-container {
                padding: 10px;
                overflow-x: auto;
            }

            .chart-canvas-container canvas {
                max-width: 100%;
                height: auto !important;
            }

            .chart-data-table {
                padding: 10px;
            }

            .chart-data-table h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .chart-data-table table {
                min-width: 0;
                font-size: 10px;
            }

            .chart-data-table th,
            .chart-data-table td {
                padding: 4px 2px;
                font-size: 10px;
                white-space: normal;
                word-break: break-word;
            }

            /* æ‰‹æ©Ÿç‰ˆè¡¨é ­ç¸®å¯« */
            .chart-data-table th:nth-child(1) { width: 8%; }  /* å±€æ•¸ */
            .chart-data-table th:nth-child(2) { width: 8%; }  /* çµæœ */
            .chart-data-table th:nth-child(3) { width: 10%; } /* èŠç´¯è¨ˆ */
            .chart-data-table th:nth-child(4) { width: 10%; } /* é–’ç´¯è¨ˆ */
            .chart-data-table th:nth-child(5) { width: 10%; } /* ç¸½å±€æ•¸ */
            .chart-data-table th:nth-child(6) { width: 18%; } /* èŠæ¯”ç‡ */
            .chart-data-table th:nth-child(7) { width: 18%; } /* é–’æ¯”ç‡ */
            .chart-data-table th:nth-child(8) { width: 18%; } /* è·³é€£æ¯”ç‡ */
        }
    </style>
</head>
<body>
    <!-- æ¿€æ´»ç•Œé¢ -->
    <div id="activationScreen">
        <div class="activation-container">
            <div class="activation-header">
                <h1>ğŸ° å¯Œæ²åœ‹éš›</h1>
                <p>ç™¾å®¶æ¨‚å¤šè·¯å–®åˆ†æç³»çµ±</p>
            </div>

            <div class="activation-info-box">
                ğŸ’¡ <strong>æ¿€æ´»èªªæ˜ï¼š</strong><br>
                1ï¸âƒ£ è¤‡è£½ä¸‹æ–¹çš„<strong>é‚€è«‹ç¢¼</strong>ç™¼é€çµ¦ç®¡ç†å“¡<br>
                2ï¸âƒ£ ç®¡ç†å“¡æœƒç”Ÿæˆ<strong>æ¿€æ´»ç¢¼</strong>çµ¦æ‚¨<br>
                3ï¸âƒ£ è¼¸å…¥æ¿€æ´»ç¢¼å¾Œå³å¯ä½¿ç”¨ç³»çµ±
            </div>

            <div class="activation-group">
                <label>ğŸ“± æ‚¨çš„é‚€è«‹ç¢¼ (è¨­å‚™ID)</label>
                <div class="device-id-display">
                    <span id="deviceIdDisplay">è¼‰å…¥ä¸­...</span>
                    <button class="copy-device-id-btn" onclick="copyDeviceId()">
                        <i class="fas fa-copy"></i> è¤‡è£½
                    </button>
                </div>
            </div>

            <div class="activation-group">
                <label>ğŸ”‘ è¼¸å…¥æ¿€æ´»ç¢¼</label>
                <input type="text" 
                       id="activationCodeInput" 
                       class="activation-input" 
                       placeholder="è«‹è¼¸å…¥12ä½æ¿€æ´»ç¢¼"
                       maxlength="12"
                       autocomplete="off"
                       autocapitalize="characters">
            </div>

            <button class="activation-btn" onclick="activateApp()">
                <i class="fas fa-unlock"></i> æ¿€æ´»ç³»çµ±
            </button>

            <div id="activationMessage"></div>

            <div class="activation-footer">
                Â© 2025 å¯Œæ²åœ‹éš› | æ¿€æ´»å•Ÿå‹•ç³»çµ±
            </div>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ -->
    <div id="mainApp">
        <div class="container">
            <!-- é é¦– -->
            <div class="header">
                <div class="header-title">
                    <h1>å¯Œæ²åœ‹éš›-å¤šè·¯å–®åˆ†æç³»çµ±</h1>
                </div>
            </div>

        <!-- è¼¸å…¥å€ -->
        <div class="input-section">
            <textarea id="inputSeq" placeholder="è¼¸å…¥é–‹ç‰Œè¨˜éŒ„ (B=èŠ, P=é–’)&#10;ç¯„ä¾‹: BPBPPBBBPBPB"></textarea>
            <div class="input-controls">
                <button class="btn btn-banker" onclick="addResult('B')">èŠ (B)</button>
                <button class="btn btn-player" onclick="addResult('P')">é–’ (P)</button>
                <button class="btn btn-undo" onclick="undo()">
                    <i class="fas fa-undo"></i> æ’¤éŠ·
                </button>
                <button class="btn btn-chart" onclick="openChartModal()">
                    <i class="fas fa-chart-line"></i> æ›²ç·šåœ–
                </button>
                <button class="btn btn-clear" onclick="clearAll()">æ¸…é™¤</button>
                
                <!-- å¯æ‘ºç–Šçš„é€²éšåŠŸèƒ½å€ -->
                <button class="collapsible-toggle" onclick="toggleAdvanced()">
                    <i class="fas fa-cog"></i>
                    <span id="advancedToggleText">é¡¯ç¤ºé€²éšåŠŸèƒ½</span>
                    <i class="fas fa-chevron-down" id="advancedToggleIcon"></i>
                </button>
                
                <div class="collapsible-content" id="advancedContent">
                    <div class="random-group">
                        <div class="random-inputs">
                            <button class="btn btn-random" onclick="randomGenerate()">
                                <i class="fas fa-dice"></i> éš¨æ©ŸèŠé–’
                            </button>
                            <span class="random-label">æœ€å°‘:</span>
                            <input type="number" id="minCount" class="random-input" value="50" min="1" max="200">
                            <span class="random-label">æœ€å¤š:</span>
                            <input type="number" id="maxCount" class="random-input" value="70" min="1" max="200">
                            <span class="random-label">AIå±€æ•¸:</span>
                            <input type="number" id="aiStartRound" class="random-input" value="12" min="1" max="100">
                            <span class="random-label">é€£è·³æ¯”ç‡:</span>
                            <input type="number" id="jumpRatioThreshold" class="random-input" value="0.26" min="0" max="1" step="0.01">
                            <span class="random-label">é•·é¾:</span>
                            <input type="number" id="longDragonThreshold" class="random-input" value="5" min="0" max="20">
                            <span class="random-label">è·³:</span>
                            <input type="number" id="jumpPatternThreshold" class="random-input" value="2" min="0" max="10">
                            <label style="display: inline-flex; align-items: center; gap: 5px; margin-left: 10px; cursor: pointer;">
                                <input type="checkbox" id="enableWarnings" checked style="cursor: pointer;">
                                <span class="random-label" style="margin: 0;">è­¦ç¤º</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 5px; margin-left: 10px; cursor: pointer;">
                                <input type="checkbox" id="showAiStreakCount" checked style="cursor: pointer;">
                                <span class="random-label" style="margin: 0;">AIçµ±è¨ˆ</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 5px; margin-left: 10px; cursor: pointer;">
                                <input type="checkbox" id="showJumpRatio" checked style="cursor: pointer;">
                                <span class="random-label" style="margin: 0;">è·³é€£æ¯”ç‡</span>
                            </label>
                        </div>
                        
                        <!-- AI æ¨¡å¼é¸æ“‡ç¨ç«‹ä¸€æ’ -->
                        <div class="ai-mode-row">
                            <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" id="aiModeVoteCount" name="aiMode" checked style="cursor: pointer;">
                                <span class="random-label" style="margin: 0;">ç¸½æ•¸èŠé–’</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 5px; margin-left: 10px; cursor: pointer;">
                                <input type="radio" id="aiModeWinRate" name="aiMode" style="cursor: pointer;">
                                <span class="random-label" style="margin: 0;">å‹ç‡èŠé–’</span>
                            </label>
                            <span class="random-label" style="margin-left: 10px;">å‹ç‡:</span>
                            <input type="number" id="winRateThreshold" class="random-input" value="50" min="0" max="100" style="width: 50px;">
                            <span class="random-label">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AIé æ¸¬å€ -->
        <div id="aiPrediction" class="ai-prediction" style="display: none;">
            <div class="ai-header">
                <i class="fas fa-robot"></i>
                <span>AI æ™ºèƒ½çµ±è¨ˆé æ¸¬</span>
            </div>
            <div class="ai-content">
                <div class="ai-main-prediction" style="position: relative;">
                    <span class="ai-label">AI å»ºè­°ä¸‹æ³¨:</span>
                    <span class="ai-result" id="aiMainResult">--</span>
                    <!-- é‡æ³¨æé†’ -->
                    <span class="heavy-bet-alert" id="heavyBetAlert" style="display: none; margin-left: 15px; padding: 4px 12px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border-radius: 6px; font-weight: bold; font-size: 13px; animation: pulse 1.5s infinite; box-shadow: 0 2px 6px rgba(255, 107, 107, 0.4);">
                        ğŸ’ é‡æ³¨
                    </span>
                    <!-- é•·é¾æé†’ -->
                    <span class="long-dragon-alert" id="longDragonAlert" style="display: none; margin-left: 15px; padding: 4px 12px; background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%); color: white; border-radius: 6px; font-weight: bold; font-size: 13px; animation: pulse 1.5s infinite; box-shadow: 0 2px 6px rgba(255, 165, 2, 0.4);">
                        ğŸ‰ é•·é¾
                    </span>
                </div>
                <div class="ai-stats-grid">
                    <div class="ai-stat-item" id="aiStreakCountItem">
                        <span class="ai-stat-label">AIçµ±è¨ˆ:</span>
                        <span class="ai-stat-value" id="aiStreakCount">æ­£ç¢º:0 éŒ¯èª¤:0</span>
                    </div>
                    <div class="ai-stat-item">
                        <span class="ai-stat-label">AIæ­£ç¢ºç‡:</span>
                        <span class="ai-stat-value" id="aiAccuracyRate">0%</span>
                    </div>
                    <div class="ai-stat-item">
                        <span class="ai-stat-label">é€£ä¸­/é€£éŒ¯æç¤º:</span>
                        <span class="ai-stat-value" id="aiErrorStreak" style="font-weight: 900;">--</span>
                    </div>
                    <div class="ai-stat-item">
                        <span class="ai-stat-label">æœ€å¤šé€£ä¸­:</span>
                        <span class="ai-stat-value" id="aiMaxWinStreak">0æ¬¡</span>
                    </div>
                    <div class="ai-stat-item">
                        <span class="ai-stat-label">æœ€å¤šé€£éŒ¯:</span>
                        <span class="ai-stat-value" id="aiMaxLoseStreak">0æ¬¡</span>
                    </div>
                    <div class="ai-stat-item" id="jumpRatioItem">
                        <span class="ai-stat-label">è·³é€£æ¯”ç‡:</span>
                        <span class="ai-stat-value" id="jumpRatioValue">0.00</span>
                        <span class="ai-stat-value" id="jumpRatioHint" style="font-size: 12px; margin-left: 5px;"></span>
                    </div>
                </div>
                <div class="ai-warnings" id="aiWarnings" style="display: none;">
                    <div class="ai-warning-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>è­¦ç¤º: ä»¥ä¸‹è·¯å–®é€£çºŒæœªä¸­5æ¬¡ä»¥ä¸Š</span>
                    </div>
                    <div class="ai-warning-list" id="aiWarningList"></div>
                </div>
            </div>
        </div>

        <!-- è·¯å–®ç¶²æ ¼ -->
        <div id="roadsGrid" class="roads-grid"></div>
    </div>

    <script>
        let sequence = [];
        let aiPredictionHistory = []; // è¨˜éŒ„AIçš„é æ¸¬æ­·å² { prediction: 'B'/'P', actual: 'B'/'P', isCorrect: true/false }
        let lastLongDragonLength = 0; // è¨˜éŒ„ä¸Šæ¬¡é•·é¾çš„é•·åº¦ï¼Œç”¨ä¾†åˆ¤æ–·æ˜¯å¦æ˜¯æ–°çš„é•·é¾
        let longDragonInterventionUsed = false; // è¨˜éŒ„é•·é¾ä»‹å…¥æ˜¯å¦å·²ä½¿ç”¨
        let jumpInterventionUsed = false; // è¨˜éŒ„è·³ä»‹å…¥æ˜¯å¦å·²ä½¿ç”¨
        
        // è·¯å–®é…ç½® - æ ¹æ“šåœ–ç‰‡æ¯ç¨®è·¯å–®æœ‰ä¸åŒçš„é¡¯ç¤ºè¡Œæ•¸
        const roadConfigs = [
            { name: 'å¤§è·¯', size: 1, rows: 6, isBigRoad: true }, // æ–°å¢å¤§è·¯ï¼Œæ”¯æ´é¾å°¾
            { name: 'ä¸‰å¤šæ‰“', size: 3, rows: 3, isThreeMoreRoad: true },
            { name: 'äºŒç è·¯', size: 2, rows: 2, isPearlRoad: true },
            { name: 'ä¸‰ç è·¯', size: 3, rows: 3, isPearlRoad: true },
            { name: 'å››ç è·¯', size: 4, rows: 4, isPearlRoad: true },
            { name: 'äº”ç è·¯', size: 5, rows: 5, isPearlRoad: true },
            { name: 'å…­ç è·¯', size: 6, rows: 6, isPearlRoad: true },
            { name: 'ä¸ƒç è·¯', size: 7, rows: 7, isPearlRoad: true },
            { name: 'å¾®ç¬‘è·¯', size: 3, rows: 6, isSmilePath: true },
            { name: 'è·³æŠ•è·¯', size: 2, rows: 2, isJumpPath: true },
            { name: 'å·½éœ‡è·¯', size: 3, rows: 3, isXunZhenRoad: true, patterns: ['BBP', 'PPB'] },
            { name: 'å…Œè‰®è·¯', size: 3, rows: 3, isDuiGenRoad: true, patterns: ['PBB', 'BPP'] },
            { name: 'é›¢åè·¯', size: 3, rows: 3, isLiKanRoad: true, patterns: ['BPB', 'PBP'] }
        ];

        // æª¢æŸ¥ç™»å…¥ (å–®æ©Ÿç‰ˆ - ç§»é™¤é©—è­‰)
        async function checkLoginStatus() {
            // å–®æ©Ÿç‰ˆä¸éœ€è¦ç™»å…¥ï¼Œä½†ä¿æŒ async çµæ§‹ä»¥æ¨¡æ“¬ç¶²è·¯è«‹æ±‚å»¶é²
            return new Promise((resolve) => {
                // ç¢ºä¿ DOM å…ƒç´ å·²ç¶“å­˜åœ¨
                setTimeout(() => {
                    const userDisplay = document.getElementById('userDisplay');
                    if (userDisplay) {
                        userDisplay.textContent = 'å–®æ©Ÿç‰ˆç”¨æˆ¶';
                    }
                    resolve();
                }, 10); // 10ms å»¶é²ï¼Œç¢ºä¿DOMå®Œå…¨è¼‰å…¥
            });
        }

        // ç™»å‡º (å–®æ©Ÿç‰ˆ - ç§»é™¤åŠŸèƒ½)
        function logout() {
            alert('å–®æ©Ÿç‰ˆç„¡éœ€ç™»å‡ºåŠŸèƒ½');
        }

        // æ·»åŠ çµæœ
        function addResult(result) {
            // åœ¨æ·»åŠ æ–°çµæœå‰,å…ˆæª¢æŸ¥æ˜¯å¦æœ‰AIé æ¸¬,ä¸¦è¨˜éŒ„é æ¸¬çµæœ
            const aiResultElement = document.getElementById('aiMainResult');
            
            if (aiResultElement && aiResultElement.textContent !== '--') {
                const aiPredText = aiResultElement.textContent.trim();
                let aiPrediction = null;
                
                if (aiPredText.includes('èŠ') || aiPredText.includes('(B)')) {
                    aiPrediction = 'B';
                } else if (aiPredText.includes('é–’') || aiPredText.includes('(P)')) {
                    aiPrediction = 'P';
                }
                
                // å¦‚æœæœ‰æœ‰æ•ˆçš„AIé æ¸¬,è¨˜éŒ„é€™æ¬¡é æ¸¬å’Œå¯¦éš›çµæœ
                if (aiPrediction) {
                    const isCorrect = (aiPrediction === result);
                    aiPredictionHistory.push({
                        prediction: aiPrediction,
                        actual: result,
                        isCorrect: isCorrect
                    });
                }
            }
            
            document.getElementById('inputSeq').value += result;
            analyzeAll(); // å³æ™‚åˆ†æ
        }

        // æ’¤éŠ·æœ€å¾Œä¸€å€‹è¼¸å…¥
        function undo() {
            const textarea = document.getElementById('inputSeq');
            const current = textarea.value;
            if (current.length > 0) {
                // åˆªé™¤æœ€å¾Œä¸€å€‹è¼¸å…¥
                textarea.value = current.slice(0, -1);
                
                // åŒæ™‚åˆªé™¤æœ€å¾Œä¸€ç­†AIé æ¸¬æ­·å²è¨˜éŒ„
                if (aiPredictionHistory.length > 0) {
                    aiPredictionHistory.pop();
                }
                
                // é‡æ–°åˆ†æ
                analyzeAll();
            }
        }

        // éš¨æ©Ÿç”ŸæˆèŠé–’
        function randomGenerate() {
            const minCount = parseInt(document.getElementById('minCount').value) || 50;
            const maxCount = parseInt(document.getElementById('maxCount').value) || 70;
            
            // é©—è­‰ç¯„åœ
            if (minCount > maxCount) {
                alert('æœ€å°‘æ•¸é‡ä¸èƒ½å¤§æ–¼æœ€å¤šæ•¸é‡ï¼');
                return;
            }
            
            if (minCount < 1 || maxCount > 200) {
                alert('æ•¸é‡ç¯„åœå¿…é ˆåœ¨ 1-200 ä¹‹é–“ï¼');
                return;
            }
            
            // éš¨æ©Ÿç”Ÿæˆæ•¸é‡
            const count = Math.floor(Math.random() * (maxCount - minCount + 1)) + minCount;
            
            // ç”Ÿæˆéš¨æ©ŸèŠé–’åºåˆ—
            let randomSeq = '';
            for (let i = 0; i < count; i++) {
                randomSeq += Math.random() < 0.5 ? 'B' : 'P';
            }
            
            // è¨­ç½®åˆ°è¼¸å…¥æ¡†ä¸¦åˆ†æ
            document.getElementById('inputSeq').value = randomSeq;
            analyzeAll();
        }

        // è§£æè¼¸å…¥
        function parseInput(input) {
            return input.toUpperCase()
                .replace(/èŠ/g, 'B')
                .replace(/é–’/g, 'P')
                .replace(/åº„/g, 'B')
                .split('')
                .filter(c => ['B', 'P'].includes(c));
        }

        // åˆ‡æ›é€²éšåŠŸèƒ½é¡¯ç¤º/éš±è—
        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const text = document.getElementById('advancedToggleText');
            const icon = document.getElementById('advancedToggleIcon');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                text.textContent = 'é¡¯ç¤ºé€²éšåŠŸèƒ½';
                icon.className = 'fas fa-chevron-down';
            } else {
                content.classList.add('show');
                text.textContent = 'éš±è—é€²éšåŠŸèƒ½';
                icon.className = 'fas fa-chevron-up';
            }
        }

        // æ¸…é™¤
        function clearAll() {
            document.getElementById('inputSeq').value = '';
            sequence = [];
            aiPredictionHistory = []; // æ¸…é™¤AIé æ¸¬æ­·å²
            lastLongDragonLength = 0; // é‡ç½®é•·é¾ç‹€æ…‹
            longDragonInterventionUsed = false; // é‡ç½®é•·é¾ä»‹å…¥æ¨™è¨˜
            jumpInterventionUsed = false; // é‡ç½®è·³ä»‹å…¥æ¨™è¨˜
            initializeEmptyRoads();
            // éš±è— AI é æ¸¬å€å¡Š
            document.getElementById('aiPrediction').style.display = 'none';
        }

        // åˆå§‹åŒ–ç©ºè·¯å–®
        function initializeEmptyRoads() {
            console.log('é–‹å§‹åˆå§‹åŒ–ç©ºè·¯å–®...');
            const grid = document.getElementById('roadsGrid');
            if (!grid) {
                console.error('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° roadsGrid å…ƒç´ ï¼');
                return;
            }
            console.log('æ‰¾åˆ° roadsGrid å…ƒç´ ï¼Œæº–å‚™æ¸…ç©ºä¸¦é‡æ–°ç”Ÿæˆ...');
            grid.innerHTML = '';

            roadConfigs.forEach((config, index) => {
                console.log(`ç”Ÿæˆç¬¬ ${index + 1} å€‹è·¯å–®ï¼š${config.name}`);
                grid.appendChild(createEmptyRoadCard(config));
            });
            console.log(`å®Œæˆï¼å…±ç”Ÿæˆ ${roadConfigs.length} å€‹ç©ºè·¯å–®`);
        }

        // å‰µå»ºç©ºè·¯å–®å¡ç‰‡
        function createEmptyRoadCard(config) {
            const card = document.createElement('div');
            card.className = 'road-card';

            const header = document.createElement('div');
            header.className = 'road-header';
            header.innerHTML = `
                <span class="road-name">${config.name}</span>
            `;
            card.appendChild(header);

            // ç©ºçš„ç ç›¤è·¯æ ¼å­
            const beadRoad = createBeadRoad([], config.rows, true);
            card.appendChild(beadRoad);

            // å¤§è·¯ä¸éœ€è¦çµ±è¨ˆï¼Œç›´æ¥è¿”å›
            if (config.isBigRoad) {
                return card;
            }

            // çµ±è¨ˆè³‡è¨Š (åœ¨ç ç›¤è·¯ä¸‹æ–¹)
            const statsInfo = document.createElement('div');
            statsInfo.className = 'road-stats';
            
            // æ ¹æ“šè·¯å–®é¡å‹æ±ºå®šæ¨™ç±¤
            let followLabel = 'æ­£æ‰“';
            let counterLabel = 'åæ‰“';
            if (config.isThreeMoreRoad) {
                followLabel = 'æ­£æ‰“';
                counterLabel = 'åæ‰“';
            } else if (config.isSmilePath) {
                followLabel = 'æ‰“é€£';
                counterLabel = 'æ‰“è·³';
            } else if (config.isJumpPath) {
                followLabel = 'èŠé–’';
                counterLabel = 'é–’èŠ';
            } else if (config.isXunZhenRoad) {
                followLabel = 'èŠèŠé–’';
                counterLabel = 'é–’é–’èŠ';
            } else if (config.isDuiGenRoad) {
                followLabel = 'é–’èŠèŠ';
                counterLabel = 'èŠé–’é–’';
            } else if (config.isLiKanRoad) {
                followLabel = 'èŠé–’èŠ';
                counterLabel = 'é–’èŠé–’';
            }
            
            // æ­£æ‰“æ ¼å­ (æ ¹æ“šè·¯å–®é¡å‹é¡¯ç¤ºå°æ‡‰æ¨™ç±¤)
            const followBox = document.createElement('div');
            followBox.className = 'stat-box';
            const followRow = document.createElement('div');
            followRow.className = 'stat-box-row';
            followRow.innerHTML = `
                <div class="stat-header">${followLabel} ã€æ­£ç¢º: 0 éŒ¯èª¤: 0ã€‘</div>
                <div class="stat-info">ã€å‹ç‡: 0% è² ç‡: 0%ã€‘æç¤º: --</div>
            `;
            followBox.appendChild(followRow);
            
            const followBeadsContainer = document.createElement('div');
            followBeadsContainer.className = 'stat-beads-container';
            followBeadsContainer.appendChild(createEmptyStatBeads());
            followBox.appendChild(followBeadsContainer);
            statsInfo.appendChild(followBox);

            // åæ‰“æ ¼å­ (æ ¹æ“šè·¯å–®é¡å‹é¡¯ç¤ºå°æ‡‰æ¨™ç±¤)
            const counterBox = document.createElement('div');
            counterBox.className = 'stat-box';
            const counterRow = document.createElement('div');
            counterRow.className = 'stat-box-row';
            counterRow.innerHTML = `
                <div class="stat-header">${counterLabel} ã€æ­£ç¢º: 0 éŒ¯èª¤: 0ã€‘</div>
                <div class="stat-info">ã€å‹ç‡: 0% è² ç‡: 0%ã€‘æç¤º: --</div>
            `;
            counterBox.appendChild(counterRow);
            
            const counterBeadsContainer = document.createElement('div');
            counterBeadsContainer.className = 'stat-beads-container';
            counterBeadsContainer.appendChild(createEmptyStatBeads());
            counterBox.appendChild(counterBeadsContainer);
            statsInfo.appendChild(counterBox);
            
            card.appendChild(statsInfo);

            return card;
        }

        // åˆ†ææ‰€æœ‰è·¯å–®
        function analyzeAll() {
            const input = document.getElementById('inputSeq').value;
            sequence = parseInput(input);

            if (sequence.length === 0) {
                initializeEmptyRoads();
                return;
            }

            generateAllRoads();
        }

        // ç”Ÿæˆæ‰€æœ‰è·¯å–®
        function generateAllRoads() {
            const grid = document.getElementById('roadsGrid');
            grid.innerHTML = '';

            const allStats = []; // æ”¶é›†æ‰€æœ‰è·¯å–®çš„çµ±è¨ˆæ•¸æ“š

            roadConfigs.forEach(config => {
                // åªè¦æœ‰è¼¸å…¥å°±é¡¯ç¤ºè·¯å–®å¡ç‰‡
                if (sequence.length > 0) {
                    const card = createRoadCard(config);
                    grid.appendChild(card);
                    
                    // æ”¶é›†çµ±è¨ˆæ•¸æ“šç”¨æ–¼AIåˆ†æ
                    const groups = [];
                    for (let i = 0; i <= sequence.length - config.size; i++) {
                        groups.push(sequence.slice(i, i + config.size));
                    }
                    const stats = calculateStats(groups, config);
                    allStats.push({
                        name: config.name,
                        stats: stats,
                        config: config
                    });
                } else {
                    grid.appendChild(createEmptyRoadCard(config));
                }
            });

            // åŸ·è¡ŒAIåˆ†æ
            if (sequence.length > 0) {
                performAIAnalysis(allStats);
            } else {
                document.getElementById('aiPrediction').style.display = 'none';
            }
            
            // è‡ªå‹•æ»¾å‹•æ‰€æœ‰ç ç›¤è·¯åˆ°æœ€æ–°æ•¸æ“šä½ç½®(ä¸æ˜¯ç©ºç™½å€)
            setTimeout(() => {
                const allBeadRoads = document.querySelectorAll('.bead-road');
                allBeadRoads.forEach(beadRoad => {
                    const lastCol = parseInt(beadRoad.getAttribute('data-last-col') || '0');
                    
                    // è¨ˆç®—æ»¾å‹•ä½ç½®: æ¯åˆ—26px + å·¦å´è¡Œè™Ÿ20px + gap 1px
                    // æ»¾å‹•åˆ°æœ€å¾Œä¸€åˆ—æ•¸æ“š,ä¸¦ä¿ç•™ä¸€äº›å¯è¦–ç©ºé–“
                    const cellWidth = 27; // 26px + 1px gap
                    const leftLabelWidth = 20;
                    const viewportWidth = beadRoad.clientWidth;
                    
                    // è¨ˆç®—ç›®æ¨™æ»¾å‹•ä½ç½®:è®“æœ€å¾Œä¸€åˆ—æ•¸æ“šé¡¯ç¤ºåœ¨å¯è¦–å€åŸŸå…§
                    const targetScrollLeft = Math.max(0, (lastCol + 1) * cellWidth + leftLabelWidth - viewportWidth + cellWidth * 2);
                    
                    beadRoad.scrollLeft = targetScrollLeft;
                });
            }, 100); // å»¶é²ç¢ºä¿DOMå®Œå…¨æ¸²æŸ“
        }

        // AIåˆ†æå‡½æ•¸
        function performAIAnalysis(allStats) {
            // ç²å– AI è¨ˆç®—æ¨¡å¼
            const aiModeVoteCount = document.getElementById('aiModeVoteCount').checked; // ç¸½æ•¸èŠé–’æ¨¡å¼
            const aiModeWinRate = document.getElementById('aiModeWinRate').checked; // å‹ç‡èŠé–’æ¨¡å¼
            const winRateThreshold = parseFloat(document.getElementById('winRateThreshold')?.value) || 50; // å‹ç‡é–¾å€¼
            
            let bankerVotes = 0;
            let playerVotes = 0;
            let bankerWinRateSum = 0;
            let playerWinRateSum = 0;
            let validRoads = 0;
            const warnings = [];

            allStats.forEach(item => {
                const { name, stats, config } = item;
                
                // è·³éæ²’æœ‰é æ¸¬çš„è·¯å–®
                if (!stats.followPred || !stats.counterPred) return;
                
                validRoads++;
                
                // åˆ†ææ­£æ‰“é æ¸¬
                const followPred = stats.followPred[stats.followPred.length - 1];
                const counterPred = stats.counterPred[stats.counterPred.length - 1];
                
                // è¨ˆç®—å‹ç‡
                const followWinRate = stats.followTotal > 0 ? (stats.followHits / stats.followTotal) * 100 : 0;
                const counterWinRate = stats.counterTotal > 0 ? (stats.counterHits / stats.counterTotal) * 100 : 0;
                
                // æ ¹æ“šè·¯å–®é¡å‹ç²å–æ¨™ç±¤
                let followLabel = 'æ­£æ‰“';
                let counterLabel = 'åæ‰“';
                if (config.isThreeMoreRoad) {
                    followLabel = 'æ­£æ‰“';
                    counterLabel = 'åæ‰“';
                } else if (config.isSmilePath) {
                    followLabel = 'æ‰“é€£';
                    counterLabel = 'æ‰“è·³';
                } else if (config.isJumpPath) {
                    followLabel = 'èŠé–’';
                    counterLabel = 'é–’èŠ';
                } else if (config.isXunZhenRoad) {
                    followLabel = 'èŠèŠé–’';
                    counterLabel = 'é–’é–’èŠ';
                } else if (config.isDuiGenRoad) {
                    followLabel = 'é–’èŠèŠ';
                    counterLabel = 'èŠé–’é–’';
                } else if (config.isLiKanRoad) {
                    followLabel = 'èŠé–’èŠ';
                    counterLabel = 'é–’èŠé–’';
                }
                
                // === æŠ•ç¥¨é‚è¼¯ ===
                if (aiModeVoteCount) {
                    // æ¨¡å¼1: ç¸½æ•¸èŠé–’ - æŠ•ç¥¨çµ¦å‹ç‡æ›´é«˜çš„é¸é …
                    if (followWinRate >= counterWinRate && followPred !== 'åœ') {
                        if (followPred === 'B') {
                            bankerVotes++;
                            bankerWinRateSum += followWinRate;
                        } else if (followPred === 'P') {
                            playerVotes++;
                            playerWinRateSum += followWinRate;
                        }
                    } else if (counterPred !== 'åœ') {
                        if (counterPred === 'B') {
                            bankerVotes++;
                            bankerWinRateSum += counterWinRate;
                        } else if (counterPred === 'P') {
                            playerVotes++;
                            playerWinRateSum += counterWinRate;
                        }
                    }
                } else if (aiModeWinRate) {
                    // æ¨¡å¼2: å‹ç‡èŠé–’ - åªçµ±è¨ˆå‹ç‡ >= è‡ªè¨‚é–¾å€¼çš„é æ¸¬
                    if (followWinRate >= winRateThreshold && followPred !== 'åœ') {
                        if (followPred === 'B') {
                            bankerVotes++;
                            bankerWinRateSum += followWinRate;
                        } else if (followPred === 'P') {
                            playerVotes++;
                            playerWinRateSum += followWinRate;
                        }
                    }
                    
                    if (counterWinRate >= winRateThreshold && counterPred !== 'åœ') {
                        if (counterPred === 'B') {
                            bankerVotes++;
                            bankerWinRateSum += counterWinRate;
                        } else if (counterPred === 'P') {
                            playerVotes++;
                            playerWinRateSum += counterWinRate;
                        }
                    }
                }
                
                // æª¢æŸ¥é€£çºŒæœªä¸­5æ¬¡ä»¥ä¸Š
                const followMissStreak = countMissStreak(stats.followResults);
                const counterMissStreak = countMissStreak(stats.counterResults);
                
                if (followMissStreak >= 5) {
                    warnings.push({
                        road: name,
                        type: followLabel,
                        streak: followMissStreak
                    });
                }
                
                if (counterMissStreak >= 5) {
                    warnings.push({
                        road: name,
                        type: counterLabel,
                        streak: counterMissStreak
                    });
                }
            });

            // é¡¯ç¤ºAIé æ¸¬çµæœ
            const aiPrediction = document.getElementById('aiPrediction');
            aiPrediction.style.display = 'block';
            
            // === é•·é¾å’Œè·³çš„ä»‹å…¥é‚è¼¯ ===
            const longDragonThreshold = parseInt(document.getElementById('longDragonThreshold')?.value) || 0;
            const jumpPatternThreshold = parseInt(document.getElementById('jumpPatternThreshold')?.value) || 0;
            
            let longDragonIntervention = null; // é•·é¾ä»‹å…¥å»ºè­°
            let jumpPatternIntervention = null; // è·³ä»‹å…¥å»ºè­°
            
            // æª¢æŸ¥é•·é¾ï¼ˆé€£çºŒç›¸åŒçµæœï¼‰- åªæœ‰è¨­å®šå€¼å¤§æ–¼0æ‰å•Ÿç”¨
            if (longDragonThreshold > 0 && sequence.length >= longDragonThreshold) {
                // è¨ˆç®—ç•¶å‰é€£çºŒç›¸åŒçš„é•·åº¦
                let currentStreak = 1;
                const lastResult = sequence[sequence.length - 1];
                for (let i = sequence.length - 2; i >= 0; i--) {
                    if (sequence[i] === lastResult) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
                
                // æª¢æŸ¥æ˜¯å¦é”åˆ°é•·é¾é–¾å€¼ - åªåœ¨æ°å¥½ç­‰æ–¼é–¾å€¼æ™‚ä»‹å…¥ä¸€æ¬¡
                if (currentStreak === longDragonThreshold && !longDragonInterventionUsed) {
                    // å‰›å¥½é”åˆ°è¨­å®šæ¬¡æ•¸(å¦‚5æ¬¡),ä»‹å…¥ä¸€æ¬¡
                    longDragonIntervention = lastResult; // 'B' æˆ– 'P'
                    longDragonInterventionUsed = true; // æ¨™è¨˜å·²ä½¿ç”¨ä»‹å…¥
                    console.log(`ğŸ‰ é•·é¾ä»‹å…¥: å·²é€£çºŒ${currentStreak}å€‹${longDragonIntervention === 'B' ? 'èŠ' : 'é–’'}ï¼Œå»ºè­°ä¸‹æ³¨${longDragonIntervention === 'B' ? 'èŠ' : 'é–’'}ï¼ˆä»‹å…¥ä¸€æ¬¡ï¼‰`);
                } else if (currentStreak >= longDragonThreshold) {
                    // è¶…éé–¾å€¼(ç¬¬6ã€7ã€8...æ¬¡)ï¼Œä¸ä»‹å…¥ï¼Œå›åˆ°AIå»ºè­°
                    longDragonIntervention = null;
                    console.log(`ğŸ‰ é•·é¾æŒçºŒä¸­: ${currentStreak}å€‹${lastResult === 'B' ? 'èŠ' : 'é–’'}ï¼ˆå›åˆ°AIå»ºè­°ï¼‰`);
                } else {
                    // é•·é¾ä¸­æ–·äº†ï¼Œé‡ç½®ç‹€æ…‹
                    if (longDragonInterventionUsed) {
                        console.log(`ğŸ‰ é•·é¾å·²ä¸­æ–·ï¼Œé‡ç½®ç‹€æ…‹`);
                    }
                    longDragonInterventionUsed = false;
                }
            } else {
                // æ²’æœ‰é”åˆ°é•·é¾æ¢ä»¶ï¼Œé‡ç½®ç‹€æ…‹
                if (lastLongDragonLength > 0) {
                    lastLongDragonLength = 0;
                    longDragonInterventionUsed = false;
                }
            }
            
            // æª¢æŸ¥è·³ï¼ˆèŠé–’äº¤æ›¿ï¼‰- åªæœ‰è¨­å®šå€¼å¤§æ–¼0æ‰å•Ÿç”¨
            if (jumpPatternThreshold > 0 && sequence.length >= jumpPatternThreshold * 2) {
                // å¾æœ€å¾Œå¾€å‰æª¢æŸ¥é€£çºŒäº¤æ›¿çš„é•·åº¦
                // BPBP = 4å€‹é€£çºŒäº¤æ›¿ = 2çµ„ (æ¯2å€‹ç®—1çµ„)
                // PBPB = 4å€‹é€£çºŒäº¤æ›¿ = 2çµ„
                // BPBPPB = BP(2å€‹)ç„¶å¾ŒPPä¸­æ–· = 1çµ„
                let consecutiveAlternatingLength = 1; // è‡³å°‘æœ‰æœ€å¾Œä¸€å€‹
                let i = sequence.length - 1;
                
                // å¾æœ€å¾Œä¸€å€‹å¾€å‰æª¢æŸ¥,è¨ˆç®—é€£çºŒäº¤æ›¿çš„é•·åº¦
                while (i >= 1) {
                    if (sequence[i] !== sequence[i - 1]) {
                        consecutiveAlternatingLength++;
                        i--;
                    } else {
                        // é‡åˆ°é€£çºŒç›¸åŒå°±åœæ­¢
                        break;
                    }
                }
                
                // å®Œæ•´è·³çµ„æ•¸ = é€£çºŒäº¤æ›¿é•·åº¦ / 2 (ç„¡æ¢ä»¶æ¨å»)
                const completeJumpGroups = Math.floor(consecutiveAlternatingLength / 2);
                
                console.log(`ğŸ”„ è·³æª¢æŸ¥: é€£çºŒäº¤æ›¿é•·åº¦=${consecutiveAlternatingLength}, å®Œæ•´è·³çµ„æ•¸=${completeJumpGroups} (è¨­å®šé–¾å€¼:${jumpPatternThreshold}çµ„)`);
                
                // åªåœ¨æ°å¥½ç­‰æ–¼é–¾å€¼ä¸”æœªä»‹å…¥æ™‚æ‰ä»‹å…¥
                if (completeJumpGroups === jumpPatternThreshold && !jumpInterventionUsed) {
                    // æ°å¥½é”åˆ°Nçµ„,ä»‹å…¥ä¸€æ¬¡
                    const lastResult = sequence[sequence.length - 1];
                    jumpPatternIntervention = lastResult === 'B' ? 'P' : 'B';
                    jumpInterventionUsed = true;
                    console.log(`ğŸ”„ è·³ä»‹å…¥: å·²é€£çºŒè·³äº†${completeJumpGroups}çµ„ï¼ˆé•·åº¦${consecutiveAlternatingLength}ï¼‰ï¼Œå»ºè­°ä¸‹æ³¨${jumpPatternIntervention === 'B' ? 'èŠ' : 'é–’'}ï¼ˆä»‹å…¥ä¸€æ¬¡ï¼‰`);
                } else if (completeJumpGroups >= jumpPatternThreshold && jumpInterventionUsed) {
                    // è¶…éé–¾å€¼ä¸”å·²ä»‹å…¥é,å›åˆ°AIå»ºè­°
                    jumpPatternIntervention = null;
                    console.log(`ğŸ”„ è·³æŒçºŒä¸­: ${completeJumpGroups}çµ„ï¼ˆå·²ä»‹å…¥éï¼Œå›åˆ°AIå»ºè­°ï¼‰`);
                } else if (completeJumpGroups < jumpPatternThreshold) {
                    // è·³ä¸­æ–·äº†,é‡ç½®ç‹€æ…‹
                    if (jumpInterventionUsed) {
                        console.log(`ğŸ”„ è·³å·²ä¸­æ–·ï¼Œé‡ç½®ç‹€æ…‹`);
                    }
                    jumpInterventionUsed = false;
                    jumpPatternIntervention = null;
                }
            } else {
                // æ²’æœ‰é”åˆ°è·³æ¢ä»¶,é‡ç½®ç‹€æ…‹
                jumpInterventionUsed = false;
                jumpPatternIntervention = null;
            }
            
            // å„ªå…ˆé †åº: é•·é¾ > è·³ > AIçµ±è¨ˆ
            let finalSuggestion = bankerVotes > playerVotes ? 'B' : (playerVotes > bankerVotes ? 'P' : null);
            let interventionType = null;
            
            if (longDragonIntervention) {
                finalSuggestion = longDragonIntervention;
                interventionType = 'dragon';
            } else if (jumpPatternIntervention) {
                finalSuggestion = jumpPatternIntervention;
                interventionType = 'jump';
            }
            
            // ä¸»è¦å»ºè­° (æ–‡å­—ç™½è‰²ï¼Œæ¡†æ¡†èƒŒæ™¯æ ¹æ“šçµæœè®Šè‰²)
            const aiMainResultElement = document.getElementById('aiMainResult');
            if (finalSuggestion === 'B') {
                aiMainResultElement.textContent = 'èŠ (B)' + (interventionType === 'dragon' ? ' ğŸ‰' : interventionType === 'jump' ? ' ğŸ”„' : '');
                aiMainResultElement.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—
                aiMainResultElement.style.background = '#ff4757'; // ç´…è‰²èƒŒæ™¯
                aiMainResultElement.style.fontWeight = 'bold';
            } else if (finalSuggestion === 'P') {
                aiMainResultElement.textContent = 'é–’ (P)' + (interventionType === 'dragon' ? ' ğŸ‰' : interventionType === 'jump' ? ' ğŸ”„' : '');
                aiMainResultElement.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—
                aiMainResultElement.style.background = '#1e90ff'; // è—è‰²èƒŒæ™¯
                aiMainResultElement.style.fontWeight = 'bold';
            } else {
                aiMainResultElement.textContent = 'çœ‹ä¸€æŠŠ';
                aiMainResultElement.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—
                aiMainResultElement.style.background = 'rgba(255,255,255,0.3)'; // ä¿æŒåŠé€æ˜ç™½è‰²
                aiMainResultElement.style.fontWeight = 'normal';
            }
            
            // é‡æ³¨åˆ¤æ–·é‚è¼¯
            const heavyBetAlert = document.getElementById('heavyBetAlert');
            let matchingRoadsCount = 0; // ç¬¦åˆæ¢ä»¶çš„è·¯æ•¸è¨ˆæ•¸
            
            // å…ˆç¢ºå®šAIå»ºè­°çš„æ–¹å‘
            const aiSuggestion = bankerVotes > playerVotes ? 'B' : (playerVotes > bankerVotes ? 'P' : null);
            
            // åªæœ‰ç•¶AIæœ‰æ˜ç¢ºå»ºè­°æ™‚æ‰æª¢æŸ¥
            if (aiSuggestion) {
                // æª¢æŸ¥å„ç è·¯å‹ç‡æ˜¯å¦æœ‰60%ä»¥ä¸Šä¸”èˆ‡AIå»ºè­°ç›¸åŒ
                allStats.forEach(item => {
                    const { stats } = item;
                    if (!stats.followPred || !stats.counterPred) return;
                    
                    const followWinRate = stats.followTotal > 0 ? (stats.followHits / stats.followTotal) * 100 : 0;
                    const counterWinRate = stats.counterTotal > 0 ? (stats.counterHits / stats.counterTotal) * 100 : 0;
                    
                    // æª¢æŸ¥æ­£æ‰“å‹ç‡
                    if (followWinRate >= 60) {
                        const followPred = stats.followPred[stats.followPred.length - 1];
                        // æª¢æŸ¥æ˜¯å¦èˆ‡AIå»ºè­°ç›¸åŒ
                        if (followPred === aiSuggestion) {
                            matchingRoadsCount++;
                        }
                    }
                    
                    // æª¢æŸ¥åæ‰“å‹ç‡
                    if (counterWinRate >= 60) {
                        const counterPred = stats.counterPred[stats.counterPred.length - 1];
                        // æª¢æŸ¥æ˜¯å¦èˆ‡AIå»ºè­°ç›¸åŒ
                        if (counterPred === aiSuggestion) {
                            matchingRoadsCount++;
                        }
                    }
                });
            }
            
            // é¡¯ç¤ºæˆ–éš±è—é‡æ³¨æé†’ (éœ€è¦4è·¯ä»¥ä¸Šç¬¦åˆæ¢ä»¶)
            if (matchingRoadsCount >= 4) {
                heavyBetAlert.style.display = 'inline-block';
            } else {
                heavyBetAlert.style.display = 'none';
            }
            
            // çµ±è¨ˆæ•¸æ“š (å·²ç§»é™¤å»ºè­°è·¯æ•¸å’Œå¹³å‡å‹ç‡é¡¯ç¤º)
            // document.getElementById('aiBankerCount').textContent = bankerVotes;
            // document.getElementById('aiPlayerCount').textContent = playerVotes;
            
            // const avgBankerWinRate = bankerVotes > 0 ? (bankerWinRateSum / bankerVotes).toFixed(1) : 0;
            // const avgPlayerWinRate = playerVotes > 0 ? (playerWinRateSum / playerVotes).toFixed(1) : 0;
            // document.getElementById('aiBankerWinRate').textContent = avgBankerWinRate + '%';
            // document.getElementById('aiPlayerWinRate').textContent = avgPlayerWinRate + '%';
            
            // è¨ˆç®—AIé æ¸¬æ­·å²çš„æ­£ç¢ºå’ŒéŒ¯èª¤æ¬¡æ•¸
            let aiCorrectCount = 0;
            let aiWrongCount = 0;
            let aiCurrentStreak = 0;
            
            // çµ±è¨ˆæ­·å²è¨˜éŒ„
            aiPredictionHistory.forEach(record => {
                if (record.isCorrect) {
                    aiCorrectCount++;
                } else {
                    aiWrongCount++;
                }
            });
            
            // è¨ˆç®—ç•¶å‰é€£å°æˆ–é€£éŒ¯ï¼Œä»¥åŠæœ€å¤šé€£ä¸­å’Œæœ€å¤šé€£éŒ¯
            let consecutiveStreak = 0;
            let isWinStreak = false;
            let maxWinStreak = 0;  // æœ€å¤šé€£ä¸­æ¬¡æ•¸
            let maxLoseStreak = 0; // æœ€å¤šé€£éŒ¯æ¬¡æ•¸
            
            if (aiPredictionHistory.length > 0) {
                const lastResult = aiPredictionHistory[aiPredictionHistory.length - 1].isCorrect;
                let streak = 0;
                
                for (let i = aiPredictionHistory.length - 1; i >= 0; i--) {
                    if (aiPredictionHistory[i].isCorrect === lastResult) {
                        streak++;
                    } else {
                        break;
                    }
                }
                
                aiCurrentStreak = lastResult ? streak : -streak;
                consecutiveStreak = streak;
                isWinStreak = lastResult;
                
                // è¨ˆç®—æ­·å²ä¸Šæœ€å¤šé€£ä¸­å’Œæœ€å¤šé€£éŒ¯
                let currentWinStreak = 0;
                let currentLoseStreak = 0;
                
                for (let i = 0; i < aiPredictionHistory.length; i++) {
                    if (aiPredictionHistory[i].isCorrect) {
                        currentWinStreak++;
                        if (currentLoseStreak > 0) {
                            maxLoseStreak = Math.max(maxLoseStreak, currentLoseStreak);
                            currentLoseStreak = 0;
                        }
                    } else {
                        currentLoseStreak++;
                        if (currentWinStreak > 0) {
                            maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                            currentWinStreak = 0;
                        }
                    }
                }
                
                // è™•ç†æœ€å¾Œä¸€æ®µé€£çºŒ
                maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                maxLoseStreak = Math.max(maxLoseStreak, currentLoseStreak);
            }
            
            // é¡¯ç¤ºæ­£ç¢º/éŒ¯èª¤æ¬¡æ•¸
            const streakText = `æ­£ç¢º:${aiCorrectCount} éŒ¯èª¤:${aiWrongCount}`;
            document.getElementById('aiStreakCount').textContent = streakText;
            
            // è¨ˆç®—ä¸¦é¡¯ç¤º AI æ­£ç¢ºç‡ (åªè¨ˆç®—è¶…éè¨­å®šå±€æ•¸å¾Œçš„é æ¸¬)
            const aiStartRoundInput = document.getElementById('aiStartRound');
            let aiStartRound = parseInt(aiStartRoundInput.value, 10);
            
            // é©—è­‰è¼¸å…¥å€¼çš„æœ‰æ•ˆæ€§ (åªåœ¨å…§éƒ¨ä½¿ç”¨ä¿®æ­£å€¼,ä¸æ”¹è®Šç”¨æˆ¶è¼¸å…¥)
            // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºæˆ–ç„¡æ•ˆ,ä½¿ç”¨é è¨­å€¼12
            if (!aiStartRoundInput.value || isNaN(aiStartRound) || aiStartRound < 1) {
                aiStartRound = 12; // ä½¿ç”¨é è¨­å€¼ä½†ä¸ä¿®æ”¹è¼¸å…¥æ¡†
            } else if (aiStartRound > 100) {
                aiStartRound = 100; // é™åˆ¶æœ€å¤§å€¼ä½†ä¸ä¿®æ”¹è¼¸å…¥æ¡†
            }
            
            // ========================================
            // AIæ­£ç¢ºç‡è¨ˆç®— (å®Œå…¨æ ¹æ“šä½ æŒ‰çš„æ¬¡æ•¸)
            // ========================================
            let accuracyRate = 0;
            
            console.log('=== AIæ­£ç¢ºç‡è¨ˆç®— ===');
            console.log('ä½ æŒ‰çš„ç¸½æ¬¡æ•¸ (sequence.length):', sequence.length);
            console.log('AIå±€æ•¸è¨­å®š (aiStartRound):', aiStartRound);
            console.log('AIé æ¸¬è¨˜éŒ„æ•¸ (aiPredictionHistory.length):', aiPredictionHistory.length);
            
            // å®Œå…¨æ ¹æ“šä½ æŒ‰çš„æ¬¡æ•¸ä¾†åˆ¤æ–·
            if (sequence.length > aiStartRound) {
                // ä½ æŒ‰äº†å¹¾æ¬¡å°±è¦æª¢æŸ¥å¹¾æ¬¡
                // è¨­å®š12å±€,ä½ æŒ‰äº†15æ¬¡ â†’ è¦æª¢æŸ¥ 15-12=3 æ¬¡
                const totalRoundsToCheck = sequence.length - aiStartRound;
                
                console.log('è¦æª¢æŸ¥çš„æ¬¡æ•¸ (ä½ æŒ‰çš„æ¬¡æ•¸ - AIå±€æ•¸):', totalRoundsToCheck);
                
                let correctCount = 0;
                
                // æª¢æŸ¥æœ€è¿‘çš„ totalRoundsToCheck å€‹AIé æ¸¬
                // å¾ aiPredictionHistory çš„å¾Œé¢å¾€å‰æ•¸
                const startCheckIdx = aiPredictionHistory.length - totalRoundsToCheck;
                
                console.log('å¾ aiPredictionHistory[' + startCheckIdx + '] é–‹å§‹æª¢æŸ¥');
                
                for (let i = 0; i < totalRoundsToCheck; i++) {
                    const idx = startCheckIdx + i;
                    if (idx >= 0 && idx < aiPredictionHistory.length) {
                        const record = aiPredictionHistory[idx];
                        console.log(`  æª¢æŸ¥ [${idx}]:`, record.prediction, 'â†’', record.actual, '=', record.isCorrect ? 'âœ“' : 'âœ—');
                        if (record.isCorrect) {
                            correctCount++;
                        }
                    }
                }
                
                console.log('æ­£ç¢º:', correctCount, '/ ç¸½å…±:', totalRoundsToCheck);
                
                // åˆ†æ¯æ˜¯ä½ æŒ‰çš„æ¬¡æ•¸æ±ºå®šçš„,ä¸æ˜¯AIè¨˜éŒ„æ•¸
                accuracyRate = ((correctCount / totalRoundsToCheck) * 100).toFixed(1);
                console.log('æ­£ç¢ºç‡:', accuracyRate + '%');
            } else {
                console.log('ä½ é‚„æ²’æŒ‰è¶…é', aiStartRound, 'æ¬¡,ä¸è¨ˆç®—');
            }
            
            document.getElementById('aiAccuracyRate').textContent = accuracyRate + '%';
            
            // é¡¯ç¤ºé€£ä¸­/é€£éŒ¯
            const errorStreakElement = document.getElementById('aiErrorStreak');
            if (consecutiveStreak > 0) {
                if (isWinStreak) {
                    errorStreakElement.textContent = `${consecutiveStreak}é€£ä¸­`;
                    errorStreakElement.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—
                    errorStreakElement.style.backgroundColor = '#2ed573'; // ç¶ è‰²åº•è‰²
                    errorStreakElement.style.padding = '3px 10px';
                    errorStreakElement.style.borderRadius = '4px';
                } else {
                    errorStreakElement.textContent = `${consecutiveStreak}é€£éŒ¯`;
                    errorStreakElement.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—
                    errorStreakElement.style.backgroundColor = consecutiveStreak >= 3 ? '#ff4757' : '#ffa502'; // 3æ¬¡ä»¥ä¸Šç´…è‰²åº•,å¦å‰‡æ©˜è‰²åº•
                    errorStreakElement.style.padding = '3px 10px';
                    errorStreakElement.style.borderRadius = '4px';
                }
            } else {
                errorStreakElement.textContent = '--';
                errorStreakElement.style.color = '#6c757d';
                errorStreakElement.style.backgroundColor = 'transparent';
                errorStreakElement.style.padding = '0';
            }
            
            // é¡¯ç¤ºæœ€å¤šé€£ä¸­å’Œæœ€å¤šé€£éŒ¯
            document.getElementById('aiMaxWinStreak').textContent = maxWinStreak + 'æ¬¡';
            document.getElementById('aiMaxLoseStreak').textContent = maxLoseStreak + 'æ¬¡';
            
            // è¨ˆç®—ä¸¦é¡¯ç¤ºè·³é€£æ¯”ç‡
            if (sequence.length > 0) {
                const jumpRatio = calculateJumpRatio(sequence, sequence.length - 1);
                document.getElementById('jumpRatioValue').textContent = jumpRatio.toFixed(2);
                
                // è®€å–ç”¨æˆ¶è¨­å®šçš„é€£è·³æ¯”ç‡é–¾å€¼
                const jumpRatioThreshold = parseFloat(document.getElementById('jumpRatioThreshold').value) || 0.26;
                
                const hintElement = document.getElementById('jumpRatioHint');
                const longDragonAlert = document.getElementById('longDragonAlert');
                
                if (jumpRatio > jumpRatioThreshold) {
                    hintElement.textContent = '(è·³æ—º)';
                    hintElement.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—
                    hintElement.style.backgroundColor = '#2ed573'; // ç¶ è‰²åº•è‰²
                    hintElement.style.padding = '2px 8px';
                    hintElement.style.borderRadius = '4px';
                    // è·³æ—ºæ™‚éš±è—é•·é¾æé†’
                    longDragonAlert.style.display = 'none';
                } else if (jumpRatio < jumpRatioThreshold) {
                    hintElement.textContent = '(é€£æ—º)';
                    hintElement.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—
                    hintElement.style.backgroundColor = '#ff6348'; // ç´…è‰²åº•è‰²
                    hintElement.style.padding = '2px 8px';
                    hintElement.style.borderRadius = '4px';
                    // é€£æ—ºæ™‚é¡¯ç¤ºé•·é¾æé†’
                    longDragonAlert.style.display = 'inline-block';
                } else {
                    hintElement.textContent = '(å¹³è¡¡)';
                    hintElement.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—
                    hintElement.style.backgroundColor = '#ffa502'; // æ©˜è‰²åº•è‰²
                    hintElement.style.padding = '2px 8px';
                    hintElement.style.borderRadius = '4px';
                    // å¹³è¡¡æ™‚éš±è—é•·é¾æé†’
                    longDragonAlert.style.display = 'none';
                }
            } else {
                document.getElementById('jumpRatioValue').textContent = '0.00';
                document.getElementById('jumpRatioHint').textContent = '';
            }
            
            // è­¦ç¤ºè¨Šæ¯ (æª¢æŸ¥æ˜¯å¦å•Ÿç”¨è­¦ç¤ºåŠŸèƒ½)
            const warningsDiv = document.getElementById('aiWarnings');
            const warningList = document.getElementById('aiWarningList');
            const enableWarnings = document.getElementById('enableWarnings')?.checked !== false; // é è¨­ç‚º true
            
            if (enableWarnings && warnings.length > 0) {
                warningsDiv.style.display = 'block';
                warningList.innerHTML = '';
                
                warnings.forEach(warning => {
                    const item = document.createElement('div');
                    item.className = 'ai-warning-item';
                    item.innerHTML = `
                        <span>${warning.road} - ${warning.type}</span>
                        <span class="warning-badge">é€£çºŒæœªä¸­ ${warning.streak} æ¬¡</span>
                    `;
                    warningList.appendChild(item);
                });
            } else {
                warningsDiv.style.display = 'none';
            }
        }

        // è¨ˆç®—é€£çºŒæœªä¸­æ¬¡æ•¸
        function countMissStreak(results) {
            if (!results || results.length === 0) return 0;
            
            let streak = 0;
            for (let i = results.length - 1; i >= 0; i--) {
                if (results[i] === false) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        // è¨ˆç®—é€£å°æˆ–é€£éŒ¯æ¬¡æ•¸ (æ­£æ•¸=é€£å°, è² æ•¸=é€£éŒ¯)
        function countStreak(results) {
            if (!results || results.length === 0) return 0;
            
            let streak = 0;
            const lastResult = results[results.length - 1];
            
            for (let i = results.length - 1; i >= 0; i--) {
                if (results[i] === lastResult) {
                    streak++;
                } else {
                    break;
                }
            }
            
            // å¦‚æœæœ€å¾Œä¸€å€‹æ˜¯ true (å‘½ä¸­), è¿”å›æ­£æ•¸; å¦‚æœæ˜¯ false (æœªä¸­), è¿”å›è² æ•¸
            return lastResult === true ? streak : -streak;
        }

        // å‰µå»ºè·¯å–®å¡ç‰‡
        function createRoadCard(config) {
            const card = document.createElement('div');
            card.className = 'road-card';

            // åˆ†çµ„ç å­
            const groups = [];
            for (let i = 0; i <= sequence.length - config.size; i++) {
                groups.push(sequence.slice(i, i + config.size));
            }

            // è¨ˆç®—çµ±è¨ˆ (å‚³å…¥ config ç”¨æ–¼è·³æŠ•è·¯ç‰¹æ®Šè™•ç†)
            const stats = calculateStats(groups, config);

            // æ¨™é¡Œ
            const header = document.createElement('div');
            header.className = 'road-header';
            
            header.innerHTML = `
                <span class="road-name">${config.name}</span>
            `;
            card.appendChild(header);

            // ç ç›¤è·¯ - æ ¹æ“šè·¯å–®é¡å‹ä½¿ç”¨ä¸åŒé¡¯ç¤ºæ–¹å¼
            if (config.isBigRoad) {
                // å¤§è·¯: ä½¿ç”¨å¤§è·¯é‚è¼¯ï¼ˆæ”¯æ´é¾å°¾ï¼‰ï¼Œä¸é¡¯ç¤ºçµ±è¨ˆ
                card.appendChild(createBigRoadFromSequence(sequence, config.rows));
                return card; // å¤§è·¯ä¸éœ€è¦çµ±è¨ˆï¼Œç›´æ¥è¿”å›
            } else if (config.isThreeMoreRoad) {
                // ä¸‰å¤šæ‰“: é¡¯ç¤ºåŸå§‹sequence(å’Œç è·¯ä¸€æ¨£)
                card.appendChild(createBeadRoadFromSequence(sequence, config.rows));
            } else if (config.isSmilePath) {
                // å¾®ç¬‘è·¯: ä½¿ç”¨å¤§è·¯é‚è¼¯
                card.appendChild(createBigRoadFromSequence(sequence, config.rows));
            } else {
                // å…¶ä»–è·¯å–®: æ­£å¸¸é †åºé¡¯ç¤º
                card.appendChild(createBeadRoadFromSequence(sequence, config.rows));
            }

            // çµ±è¨ˆ (å«æ­£åæ‰“æ ¼å­) - åœ¨ç ç›¤è·¯ä¸‹æ–¹
            const statsDiv = document.createElement('div');
            statsDiv.className = 'road-stats';
            
            // è¨ˆç®—æç¤º
            const followLastPred = stats.followPred ? stats.followPred[stats.followPred.length - 1] : null;
            const followTip = followLastPred === 'åœ' ? 'åœ' : (followLastPred === 'B' ? 'èŠ' : (followLastPred === 'P' ? 'é–’' : '--'));
            
            const counterLastPred = stats.counterPred ? stats.counterPred[stats.counterPred.length - 1] : null;
            const counterTip = counterLastPred === 'åœ' ? 'åœ' : (counterLastPred === 'B' ? 'èŠ' : (counterLastPred === 'P' ? 'é–’' : '--'));
            
            // è¨ˆç®—æ­£ç¢º/éŒ¯èª¤æ¬¡æ•¸å’Œå‹ç‡/è² ç‡
            const followCorrect = stats.followHits;
            const followWrong = stats.followTotal - stats.followHits;
            const followWinRate = stats.followTotal > 0 ? ((stats.followHits / stats.followTotal) * 100).toFixed(0) : 0;
            const followLoseRate = stats.followTotal > 0 ? ((followWrong / stats.followTotal) * 100).toFixed(0) : 0;
            
            const counterCorrect = stats.counterHits;
            const counterWrong = stats.counterTotal - stats.counterHits;
            const counterWinRate = stats.counterTotal > 0 ? ((stats.counterHits / stats.counterTotal) * 100).toFixed(0) : 0;
            const counterLoseRate = stats.counterTotal > 0 ? ((counterWrong / stats.counterTotal) * 100).toFixed(0) : 0;
            
            // æ ¹æ“šè·¯å–®é¡å‹æ±ºå®šæ¨™ç±¤
            let followLabel = 'æ­£æ‰“';
            let counterLabel = 'åæ‰“';
            if (config.isBigRoad) {
                followLabel = 'æ‰“é€£';
                counterLabel = 'æ‰“è·³';
            } else if (config.isThreeMoreRoad) {
                followLabel = 'æ­£æ‰“';
                counterLabel = 'åæ‰“';
            } else if (config.isSmilePath) {
                followLabel = 'æ‰“é€£';
                counterLabel = 'æ‰“è·³';
            } else if (config.isJumpPath) {
                followLabel = 'èŠé–’';
                counterLabel = 'é–’èŠ';
            } else if (config.isXunZhenRoad) {
                followLabel = 'èŠèŠé–’';
                counterLabel = 'é–’é–’èŠ';
            } else if (config.isDuiGenRoad) {
                followLabel = 'é–’èŠèŠ';
                counterLabel = 'èŠé–’é–’';
            } else if (config.isLiKanRoad) {
                followLabel = 'èŠé–’èŠ';
                counterLabel = 'é–’èŠé–’';
            }
            
            // æ­£æ‰“æ ¼å­ (å¤§è·¯/ä¸‰å¤šæ‰“/å¾®ç¬‘è·¯/è·³æŠ•è·¯æœ‰ç‰¹æ®Šæ¨™ç±¤)
            const followBox = document.createElement('div');
            followBox.className = 'stat-box';
            
            // æ¨™é¡Œå’Œçµ±è¨ˆè¡Œ
            const followRow = document.createElement('div');
            followRow.className = 'stat-box-row';
            const followHeader = document.createElement('div');
            followHeader.className = 'stat-header';
            followHeader.textContent = `${followLabel} ã€æ­£ç¢º: ${followCorrect} éŒ¯èª¤: ${followWrong}ã€‘`;
            followRow.appendChild(followHeader);
            
            const followInfo = document.createElement('div');
            followInfo.className = 'stat-info';
            followInfo.innerHTML = `ã€å‹ç‡: ${followWinRate}% è² ç‡: ${followLoseRate}%ã€‘æç¤º: ${followTip}`;
            followRow.appendChild(followInfo);
            followBox.appendChild(followRow);
            
            // ç å­è¡Œ
            const followBeadsContainer = document.createElement('div');
            followBeadsContainer.className = 'stat-beads-container';
            followBeadsContainer.appendChild(createStatBeads(stats.followResults));
            followBox.appendChild(followBeadsContainer);
            
            statsDiv.appendChild(followBox);

            // åæ‰“æ ¼å­ (å¾®ç¬‘è·¯æ”¹ç‚º"æ‰“è·³",è·³æŠ•è·¯æ”¹ç‚º"é–’èŠ")
            const counterBox = document.createElement('div');
            counterBox.className = 'stat-box';
            
            // æ¨™é¡Œå’Œçµ±è¨ˆè¡Œ
            const counterRow = document.createElement('div');
            counterRow.className = 'stat-box-row';
            const counterHeader = document.createElement('div');
            counterHeader.className = 'stat-header';
            counterHeader.textContent = `${counterLabel} ã€æ­£ç¢º: ${counterCorrect} éŒ¯èª¤: ${counterWrong}ã€‘`;
            counterRow.appendChild(counterHeader);
            
            const counterInfo = document.createElement('div');
            counterInfo.className = 'stat-info';
            counterInfo.innerHTML = `ã€å‹ç‡: ${counterWinRate}% è² ç‡: ${counterLoseRate}%ã€‘æç¤º: ${counterTip}`;
            counterRow.appendChild(counterInfo);
            counterBox.appendChild(counterRow);
            
            // ç å­è¡Œ
            const counterBeadsContainer = document.createElement('div');
            counterBeadsContainer.className = 'stat-beads-container';
            counterBeadsContainer.appendChild(createStatBeads(stats.counterResults));
            counterBox.appendChild(counterBeadsContainer);
            
            statsDiv.appendChild(counterBox);

            card.appendChild(statsDiv);

            return card;
        }

        // å‰µå»ºç ç›¤è·¯ (æ ¹æ“šæ¯ç¨®è·¯å–®çš„è¡Œæ•¸ä¸åŒ)
        function createBeadRoad(groups, rows, showEmpty = false) {
            const container = document.createElement('div');
            container.className = 'bead-road';

            const cols = showEmpty ? 25 : Math.max(15, Math.ceil(groups.length / rows));
            
            const grid = document.createElement('div');
            grid.className = 'bead-grid';
            // å·¦å´è¡Œè™Ÿ + é ‚éƒ¨åˆ—è™Ÿ + æ•¸æ“šæ ¼å­
            grid.style.gridTemplateColumns = `20px repeat(${cols}, 26px)`;
            grid.style.gridTemplateRows = `20px repeat(${rows}, 26px)`;

            // å·¦ä¸Šè§’ç©ºæ ¼
            const corner = document.createElement('div');
            corner.className = 'bead-cell grid-number';
            grid.appendChild(corner);

            // é ‚éƒ¨åˆ—è™Ÿ
            for (let col = 0; col < cols; col++) {
                const cell = document.createElement('div');
                cell.className = 'bead-cell grid-number';
                cell.textContent = col + 1;
                grid.appendChild(cell);
            }

            // æ¯ä¸€è¡Œ
            for (let row = 0; row < rows; row++) {
                // å·¦å´è¡Œè™Ÿ
                const rowLabel = document.createElement('div');
                rowLabel.className = 'bead-cell row-number';
                rowLabel.textContent = row + 1;
                grid.appendChild(rowLabel);

                // ç å­æ ¼å­
                for (let col = 0; col < cols; col++) {
                    const index = col * rows + row;
                    const cell = document.createElement('div');
                    cell.className = 'bead-cell';
                    
                    if (index < groups.length && !showEmpty) {
                        const group = groups[index];
                        const lastResult = group[group.length - 1];
                        const bead = document.createElement('div');
                        bead.className = `bead bead-${lastResult}`;
                        bead.title = group.join('');
                        cell.appendChild(bead);
                    }
                    
                    grid.appendChild(cell);
                }
            }

            container.appendChild(grid);
            return container;
        }

        // å‰µå»ºè·³æŠ•è·¯ç ç›¤ (ç‰¹æ®Šé‚è¼¯:å‘½ä¸­ç¹¼çºŒå¾€ä¸‹,æœªä¸­è·³åˆ°ä¸‹ä¸€åˆ—)
        function createJumpPathRoad(seq, rows) {
            const container = document.createElement('div');
            container.className = 'bead-road';

            if (seq.length === 0) {
                return container;
            }

            // è¨ˆç®—ç å­ä½ç½® (å‘½ä¸­å¾€ä¸‹,æœªä¸­è·³åˆ—) - ä½¿ç”¨èŠé–’æ¨¡å¼(Bâ†’Pè¼ªæµ)
            const positions = [];
            let currentCol = 0;
            let currentRow = 0;
            let expecting = 'B'; // é–‹å§‹é æ¸¬èŠ

            for (let i = 0; i < seq.length; i++) {
                const current = seq[i];
                positions.push({ col: currentCol, row: currentRow, result: current });

                // åˆ¤æ–·æ˜¯å¦å‘½ä¸­
                const isHit = (current === expecting);
                
                // ç„¡è«–å‘½ä¸­èˆ‡å¦,éƒ½åˆ‡æ›é æ¸¬å€¼ (ä¸€ç›´è¼ªæµ)
                expecting = expecting === 'B' ? 'P' : 'B';
                
                // è¨ˆç®—ä¸‹ä¸€é¡†ä½ç½®
                if (i < seq.length - 1) {
                    if (isHit) {
                        // å‘½ä¸­: å¾€ä¸‹
                        currentRow++;
                        if (currentRow >= rows) {
                            currentRow = 0;
                            currentCol++;
                        }
                    } else {
                        // æœªä¸­: è·³åˆ°ä¸‹ä¸€åˆ—
                        currentCol++;
                        currentRow = 0;
                    }
                }
            }

            // è¨ˆç®—éœ€è¦çš„åˆ—æ•¸
            const maxCol = Math.max(...positions.map(p => p.col), 9); // è‡³å°‘10åˆ—
            const cols = maxCol + 1;

            const grid = document.createElement('div');
            grid.className = 'bead-grid';
            grid.style.gridTemplateColumns = `20px repeat(${cols}, 26px)`;
            grid.style.gridTemplateRows = `20px repeat(${rows}, 26px)`;

            // å·¦ä¸Šè§’ç©ºæ ¼
            const corner = document.createElement('div');
            corner.className = 'bead-cell grid-number';
            grid.appendChild(corner);

            // é ‚éƒ¨åˆ—è™Ÿ
            for (let col = 0; col < cols; col++) {
                const cell = document.createElement('div');
                cell.className = 'bead-cell grid-number';
                cell.textContent = col + 1;
                grid.appendChild(cell);
            }

            // å‰µå»ºæ ¼å­ä¸¦å¡«å…¥ç å­
            for (let row = 0; row < rows; row++) {
                // å·¦å´è¡Œè™Ÿ
                const rowLabel = document.createElement('div');
                rowLabel.className = 'bead-cell row-number';
                rowLabel.textContent = row + 1;
                grid.appendChild(rowLabel);

                for (let col = 0; col < cols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'bead-cell';
                    
                    // æ‰¾å‡ºé€™å€‹ä½ç½®çš„ç å­
                    const bead = positions.find(p => p.col === col && p.row === row);
                    if (bead) {
                        const beadEl = document.createElement('div');
                        beadEl.className = `bead bead-${bead.result}`;
                        cell.appendChild(beadEl);
                    }
                    
                    grid.appendChild(cell);
                }
            }

            container.appendChild(grid);
            return container;
        }

        // å‰µå»ºç ç›¤è·¯ (é¡¯ç¤ºåŸå§‹åºåˆ— - ç”¨æ–¼ä¸å®Œæ•´çš„çµ„)
        function createBeadRoadFromSequence(seq, rows) {
            const container = document.createElement('div');
            container.className = 'bead-road';

            const cols = Math.max(15, Math.ceil(seq.length / rows));
            
            // è¨ˆç®—æœ€å¾Œä¸€å€‹æœ‰æ•¸æ“šçš„åˆ— (å¾0é–‹å§‹)
            const lastDataCol = seq.length > 0 ? Math.ceil(seq.length / rows) - 1 : 0;
            container.setAttribute('data-last-col', lastDataCol);
            
            const grid = document.createElement('div');
            grid.className = 'bead-grid';
            grid.style.gridTemplateColumns = `20px repeat(${cols}, 26px)`;
            grid.style.gridTemplateRows = `20px repeat(${rows}, 26px)`;

            // å·¦ä¸Šè§’ç©ºæ ¼
            const corner = document.createElement('div');
            corner.className = 'bead-cell grid-number';
            grid.appendChild(corner);

            // é ‚éƒ¨åˆ—è™Ÿ
            for (let col = 0; col < cols; col++) {
                const cell = document.createElement('div');
                cell.className = 'bead-cell grid-number';
                cell.textContent = col + 1;
                grid.appendChild(cell);
            }

            // æ¯ä¸€è¡Œ
            for (let row = 0; row < rows; row++) {
                // å·¦å´è¡Œè™Ÿ
                const rowLabel = document.createElement('div');
                rowLabel.className = 'bead-cell row-number';
                rowLabel.textContent = row + 1;
                grid.appendChild(rowLabel);

                // ç å­æ ¼å­
                for (let col = 0; col < cols; col++) {
                    const index = col * rows + row;
                    const cell = document.createElement('div');
                    cell.className = 'bead-cell';
                    
                    if (index < seq.length) {
                        const result = seq[index];
                        const bead = document.createElement('div');
                        bead.className = `bead bead-${result}`;
                        cell.appendChild(bead);
                    }
                    
                    grid.appendChild(cell);
                }
            }

            container.appendChild(grid);
            return container;
        }

        // å‰µå»ºå¤§è·¯é‚è¼¯çš„ç ç›¤è·¯ (ç›¸åŒçµæœå¾€ä¸‹,ä¸åŒçµæœæ›åˆ—)
        function createBigRoadFromSequence(seq, rows) {
            const container = document.createElement('div');
            container.className = 'bead-road';

            if (seq.length === 0) {
                const cols = 15;
                const grid = document.createElement('div');
                grid.className = 'bead-grid';
                grid.style.gridTemplateColumns = `20px repeat(${cols}, 26px)`;
                grid.style.gridTemplateRows = `20px repeat(${rows}, 26px)`;
                container.appendChild(grid);
                return container;
            }

            // è¨ˆç®—ç å­ä½ç½® (å¤§è·¯é‚è¼¯: ç›¸åŒå¾€ä¸‹,ä¸åŒæ›åˆ—,æ”¯æ´é¾å°¾)
            const positions = [];
            let currentCol = 0;
            let currentRow = 0;
            let startCol = 0;
            let dragonRow = -1; // -1è¡¨ç¤ºé‚„æ²’é€²å…¥é¾å°¾æ¨¡å¼
            let prevResult = null;

            // æª¢æŸ¥æŸå€‹ä½ç½®æ˜¯å¦å·²è¢«ä½”ç”¨
            const isOccupied = (col, row) => {
                return positions.some(p => p.col === col && p.row === row);
            };

            for (let i = 0; i < seq.length; i++) {
                const current = seq[i];
                
                // å¦‚æœå’Œå‰ä¸€å€‹ä¸åŒ,æ›åˆ°ä¸‹ä¸€åˆ—,é‡ç½®é¾å°¾ç‹€æ…‹
                if (prevResult !== null && prevResult !== current) {
                    currentCol = startCol + 1;
                    startCol = currentCol;
                    currentRow = 0;
                    dragonRow = -1;
                }
                
                // è¨˜éŒ„ç•¶å‰ä½ç½®
                positions.push({ col: currentCol, row: currentRow, result: current });
                
                // æº–å‚™ä¸‹ä¸€é¡†ä½ç½®(å¦‚æœä¸‹ä¸€é¡†å’Œç•¶å‰ç›¸åŒ)
                if (i < seq.length - 1 && seq[i + 1] === current) {
                    if (dragonRow !== -1) {
                        // å·²ç¶“åœ¨é¾å°¾æ¨¡å¼: åªèƒ½å¾€å³
                        currentCol++;
                        currentRow = dragonRow;
                        // æª¢æŸ¥ä¸¦é¿é–‹å·²ä½”ç”¨çš„ä½ç½®
                        while (isOccupied(currentCol, currentRow)) {
                            currentCol++;
                        }
                    } else if (currentRow < rows - 1 && !isOccupied(currentCol, currentRow + 1)) {
                        // å¯ä»¥å¾€ä¸‹
                        currentRow++;
                    } else {
                        // é€²å…¥é¾å°¾æ¨¡å¼
                        dragonRow = currentRow;
                        currentCol++;
                        currentRow = dragonRow;
                        // æª¢æŸ¥ä¸¦é¿é–‹å·²ä½”ç”¨çš„ä½ç½®
                        while (isOccupied(currentCol, currentRow)) {
                            currentCol++;
                        }
                    }
                }
                
                prevResult = current;
            }

            // è¨ˆç®—éœ€è¦çš„åˆ—æ•¸
            const maxCol = Math.max(...positions.map(p => p.col));
            const cols = Math.max(15, maxCol + 2);
            
            // è¨˜éŒ„æœ€å¾Œä¸€å€‹æœ‰æ•¸æ“šçš„åˆ—
            container.setAttribute('data-last-col', maxCol);

            const grid = document.createElement('div');
            grid.className = 'bead-grid';
            grid.style.gridTemplateColumns = `20px repeat(${cols}, 26px)`;
            grid.style.gridTemplateRows = `20px repeat(${rows}, 26px)`;

            // å·¦ä¸Šè§’ç©ºæ ¼
            const corner = document.createElement('div');
            corner.className = 'bead-cell grid-number';
            grid.appendChild(corner);

            // é ‚éƒ¨åˆ—è™Ÿ
            for (let col = 0; col < cols; col++) {
                const cell = document.createElement('div');
                cell.className = 'bead-cell grid-number';
                cell.textContent = col + 1;
                grid.appendChild(cell);
            }

            // å‰µå»ºä½ç½®æ˜ å°„
            const posMap = new Map();
            positions.forEach(p => {
                const key = `${p.col},${p.row}`;
                posMap.set(key, p.result);
            });

            // æ¯ä¸€è¡Œ
            for (let row = 0; row < rows; row++) {
                // å·¦å´è¡Œè™Ÿ
                const rowLabel = document.createElement('div');
                rowLabel.className = 'bead-cell row-number';
                rowLabel.textContent = row + 1;
                grid.appendChild(rowLabel);

                // ç å­æ ¼å­
                for (let col = 0; col < cols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'bead-cell';
                    
                    const key = `${col},${row}`;
                    if (posMap.has(key)) {
                        const result = posMap.get(key);
                        const bead = document.createElement('div');
                        bead.className = `bead bead-${result}`;
                        cell.appendChild(bead);
                    }
                    
                    grid.appendChild(cell);
                }
            }

            container.appendChild(grid);
            return container;
        }

        // è¨ˆç®—çµ±è¨ˆ
        function calculateStats(groups, config) {
            // å¤§è·¯ç‰¹æ®Šè™•ç†: é æ¸¬ä¸‹ä¸€é¡†ï¼Œæ­£æ‰“=è·Ÿä¸Šä¸€é¡†ç›¸åŒï¼Œåæ‰“=è·Ÿä¸Šä¸€é¡†ç›¸å
            if (config && config.isBigRoad && sequence.length >= 1) {
                const bankerCount = sequence.filter(s => s === 'B').length;
                const playerCount = sequence.length - bankerCount;

                let followHits = 0, counterHits = 0;
                const followResults = [], counterResults = [];
                const followPred = [], counterPred = [];

                // å¾ç¬¬2é¡†é–‹å§‹é æ¸¬ï¼ˆç¬¬1é¡†ç”¨ä¾†è§€å¯Ÿï¼‰
                for (let i = 1; i < sequence.length; i++) {
                    const prevResult = sequence[i - 1]; // ä¸Šä¸€é¡†
                    const currentResult = sequence[i]; // ç•¶å‰é€™é¡†
                    
                    // æ­£æ‰“: é æ¸¬è·Ÿä¸Šä¸€é¡†ç›¸åŒ
                    const followPrediction = prevResult;
                    const followHit = followPrediction === currentResult;
                    followResults.push(followHit);
                    followPred.push(followPrediction);
                    if (followHit) followHits++;
                    
                    // åæ‰“: é æ¸¬è·Ÿä¸Šä¸€é¡†ç›¸å
                    const counterPrediction = prevResult === 'B' ? 'P' : 'B';
                    const counterHit = counterPrediction === currentResult;
                    counterResults.push(counterHit);
                    counterPred.push(counterPrediction);
                    if (counterHit) counterHits++;
                }

                const followTotal = followResults.length;
                const counterTotal = counterResults.length;

                // ä¸‹ä¸€é¡†çš„é æ¸¬
                if (sequence.length > 0) {
                    const lastResult = sequence[sequence.length - 1];
                    followPred.push(lastResult); // æ­£æ‰“: è·Ÿä¸Šä¸€é¡†ç›¸åŒ
                    counterPred.push(lastResult === 'B' ? 'P' : 'B'); // åæ‰“: è·Ÿä¸Šä¸€é¡†ç›¸å
                }

                return {
                    bankerCount,
                    playerCount,
                    followHits,
                    counterHits,
                    followTotal,
                    counterTotal,
                    followResults,
                    counterResults,
                    followPred,
                    counterPred
                };
            }
            
            // ä¸‰å¤šæ‰“ç‰¹æ®Šè™•ç†: ç¬¬1çµ„è§€å¯Ÿ,ç¬¬2çµ„é–‹å§‹é æ¸¬,å‘½ä¸­åœæ­¢
            if (config && config.isThreeMoreRoad && sequence.length >= 1) {
                const bankerCount = sequence.filter(s => s === 'B').length;
                const playerCount = sequence.length - bankerCount;

                let followHits = 0, counterHits = 0;
                const followResults = [], counterResults = [];
                let followPred = ['åœ'], counterPred = ['åœ'];
                let followStopped = false, counterStopped = false;

                // ç•¶å‰è™•ç†åˆ°ç¬¬å¹¾çµ„(0-based)
                const currentGroupIndex = Math.floor((sequence.length - 1) / 3);
                const posInGroup = (sequence.length - 1) % 3; // ç•¶å‰é€™é¡†åœ¨çµ„å…§çš„ä½ç½®(0,1,2)

                // è™•ç†æ¯å€‹å®Œæ•´çš„3é¡†çµ„
                let observeGroupResult = null; // å‰ä¸€çµ„çš„çµæœ(èŠå¤š/é–’å¤š)
                
                for (let groupIdx = 0; groupIdx <= currentGroupIndex; groupIdx++) {
                    const groupStart = groupIdx * 3;
                    const groupEnd = Math.min(groupStart + 3, sequence.length);
                    
                    if (groupIdx === 0) {
                        // ç¬¬1çµ„: è§€å¯Ÿ
                        if (groupEnd - groupStart === 3) {
                            // ç¬¬1çµ„å®Œæ•´äº†,è¨ˆç®—çµæœ
                            const group = sequence.slice(groupStart, groupEnd);
                            const bankerInGroup = group.filter(s => s === 'B').length;
                            observeGroupResult = bankerInGroup > 1 ? 'B' : 'P'; // 2æˆ–3å€‹èŠ=èŠå¤š,å¦å‰‡é–’å¤š
                        }
                    } else {
                        // ç¬¬2çµ„ä»¥å¾Œ: é æ¸¬
                        if (observeGroupResult !== null) {
                            // åªè™•ç†é€™çµ„å·²é–‹å‡ºçš„ç å­
                            for (let i = groupStart; i < groupEnd; i++) {
                                const posInCurrentGroup = i - groupStart; // 0, 1, æˆ– 2
                                
                                if (posInCurrentGroup === 0) {
                                    // é€™çµ„çš„ç¬¬1é¡†: é‡ç½®åœæ­¢ç‹€æ…‹
                                    followStopped = false;
                                    counterStopped = false;
                                }
                                
                                const current = sequence[i];
                                
                                // æ­£æ‰“: é æ¸¬å’Œå‰ä¸€çµ„çµæœç›¸åŒ
                                if (!followStopped) {
                                    const followHit = (current === observeGroupResult);
                                    followResults.push(followHit);
                                    if (followHit) {
                                        followHits++;
                                        followStopped = true; // å‘½ä¸­å¾Œåœæ­¢
                                    }
                                }
                                
                                // åæ‰“: é æ¸¬å’Œå‰ä¸€çµ„çµæœç›¸å
                                if (!counterStopped) {
                                    const counterHit = (current !== observeGroupResult);
                                    counterResults.push(counterHit);
                                    if (counterHit) {
                                        counterHits++;
                                        counterStopped = true;
                                    }
                                }
                            }
                            
                            // å¦‚æœé€™çµ„å®Œæ•´äº†,æ›´æ–°è§€å¯Ÿçµ„çµæœ
                            if (groupEnd - groupStart === 3) {
                                const group = sequence.slice(groupStart, groupEnd);
                                const bankerInGroup = group.filter(s => s === 'B').length;
                                observeGroupResult = bankerInGroup > 1 ? 'B' : 'P';
                            }
                        }
                    }
                }

                // è¨ˆç®—ä¸‹ä¸€é¡†æç¤º
                if (observeGroupResult !== null) {
                    const nextPos = sequence.length % 3; // ä¸‹ä¸€é¡†åœ¨çµ„å…§çš„ä½ç½®
                    
                    if (nextPos === 0) {
                        // ä¸‹ä¸€é¡†æ˜¯æ–°çµ„ç¬¬1é¡† â†’ æ ¹æ“šå‰ä¸€çµ„é æ¸¬
                        followPred = [observeGroupResult]; // æ­£æ‰“: å’Œå‰ä¸€çµ„ç›¸åŒ
                        counterPred = [observeGroupResult === 'B' ? 'P' : 'B']; // åæ‰“: ç›¸å
                    } else {
                        // ä¸‹ä¸€é¡†æ˜¯ç•¶å‰çµ„çš„ç¬¬2æˆ–ç¬¬3é¡†
                        if (followStopped) {
                            followPred = ['åœ'];
                        } else {
                            followPred = [observeGroupResult];
                        }
                        
                        if (counterStopped) {
                            counterPred = ['åœ'];
                        } else {
                            counterPred = [observeGroupResult === 'B' ? 'P' : 'B'];
                        }
                    }
                }

                return {
                    bankerRate: ((bankerCount / sequence.length) * 100).toFixed(0),
                    playerRate: ((playerCount / sequence.length) * 100).toFixed(0),
                    followHits,
                    followTotal: followResults.length,
                    counterHits,
                    counterTotal: counterResults.length,
                    followPred,
                    counterPred,
                    followResults,
                    counterResults
                };
            }
            
            // ç è·¯ç‰¹æ®Šè™•ç†(äºŒç è·¯~ä¸ƒç è·¯): ç¬¬1é¡†è§€å¯Ÿ,å…¶é¤˜é æ¸¬,å‘½ä¸­å¾Œåœæ­¢
            if (config && config.isPearlRoad && sequence.length >= 1) {
                const groupSize = config.size; // 2, 3, 4, 5, 6, æˆ– 7
                const bankerCount = sequence.filter(s => s === 'B').length;
                const playerCount = sequence.length - bankerCount;

                let followHits = 0, counterHits = 0;
                const followResults = [], counterResults = [];
                let followPred = ['åœ'], counterPred = ['åœ'];
                let followStopped = false, counterStopped = false; // è¨˜éŒ„æ˜¯å¦å·²å‘½ä¸­åœæ­¢

                for (let i = 0; i < sequence.length; i++) {
                    const posInGroup = i % groupSize; // 0=ç¬¬1é¡†, 1=ç¬¬2é¡†, 2=ç¬¬3é¡†...
                    
                    if (posInGroup === 0) {
                        // ç¬¬1é¡†: è§€å¯Ÿ,ä¸æ¨ç å­,é‡ç½®åœæ­¢ç‹€æ…‹
                        followStopped = false;
                        counterStopped = false;
                    } else {
                        // ç¬¬2é¡†ä¹‹å¾Œ: é æ¸¬
                        const groupStart = i - posInGroup;
                        const observeBead = sequence[groupStart]; // é€™çµ„çš„ç¬¬1é¡†
                        const current = sequence[i];
                        
                        // æ­£æ‰“: é æ¸¬å’Œç¬¬1é¡†ç›¸åŒ
                        if (!followStopped) {
                            const followHit = (current === observeBead);
                            followResults.push(followHit);
                            if (followHit) {
                                followHits++;
                                followStopped = true; // å‘½ä¸­å¾Œåœæ­¢
                            }
                        }
                        
                        // åæ‰“: é æ¸¬å’Œç¬¬1é¡†ç›¸å
                        if (!counterStopped) {
                            const counterHit = (current !== observeBead);
                            counterResults.push(counterHit);
                            if (counterHit) {
                                counterHits++;
                                counterStopped = true; // å‘½ä¸­å¾Œåœæ­¢
                            }
                        }
                    }
                }

                // è¨ˆç®—ä¸‹ä¸€é¡†æç¤º
                const currentPos = (sequence.length - 1) % groupSize; // ç•¶å‰é€™é¡†åœ¨çµ„å…§çš„ä½ç½®
                const nextPos = sequence.length % groupSize; // ä¸‹ä¸€é¡†åœ¨çµ„å…§çš„ä½ç½®
                
                // æ­£æ‰“æç¤º
                if (nextPos === 0) {
                    // å‰›é–‹å®Œæœ€å¾Œä¸€é¡†,ä¸‹ä¸€é¡†æ˜¯æ–°çµ„ç¬¬1é¡†(è§€å¯Ÿ) â†’ æç¤º"åœ"
                    followPred = ['åœ'];
                } else if (nextPos === 1) {
                    // å‰›é–‹å®Œç¬¬1é¡†(è§€å¯Ÿ),ä¸‹ä¸€é¡†æ˜¯ç¬¬2é¡† â†’ æç¤ºé æ¸¬(å’Œç¬¬1é¡†ç›¸åŒ)
                    const groupStart = sequence.length - 1; // ç¬¬1é¡†çš„ä½ç½®å°±æ˜¯ç•¶å‰-1
                    const observeBead = sequence[groupStart];
                    followPred = [observeBead];
                } else {
                    // å‰›é–‹å®Œç¬¬2é¡†æˆ–ä¹‹å¾Œ,ä¸‹ä¸€é¡†æ˜¯ç¬¬3é¡†æˆ–ä¹‹å¾Œ
                    if (followStopped) {
                        // å·²å‘½ä¸­ â†’ æç¤º"åœ"
                        followPred = ['åœ'];
                    } else {
                        // æœªä¸­ â†’ ç¹¼çºŒæç¤ºé æ¸¬
                        const groupStart = sequence.length - nextPos; // ç¬¬1é¡†çš„ä½ç½®
                        const observeBead = sequence[groupStart];
                        followPred = [observeBead];
                    }
                }
                
                // åæ‰“æç¤º
                if (nextPos === 0) {
                    // å‰›é–‹å®Œæœ€å¾Œä¸€é¡†,ä¸‹ä¸€é¡†æ˜¯æ–°çµ„ç¬¬1é¡†(è§€å¯Ÿ) â†’ æç¤º"åœ"
                    counterPred = ['åœ'];
                } else if (nextPos === 1) {
                    // å‰›é–‹å®Œç¬¬1é¡†(è§€å¯Ÿ),ä¸‹ä¸€é¡†æ˜¯ç¬¬2é¡† â†’ æç¤ºé æ¸¬(å’Œç¬¬1é¡†ç›¸å)
                    const groupStart = sequence.length - 1;
                    const observeBead = sequence[groupStart];
                    counterPred = [observeBead === 'B' ? 'P' : 'B'];
                } else {
                    // å‰›é–‹å®Œç¬¬2é¡†æˆ–ä¹‹å¾Œ,ä¸‹ä¸€é¡†æ˜¯ç¬¬3é¡†æˆ–ä¹‹å¾Œ
                    if (counterStopped) {
                        // å·²å‘½ä¸­ â†’ æç¤º"åœ"
                        counterPred = ['åœ'];
                    } else {
                        // æœªä¸­ â†’ ç¹¼çºŒæç¤ºé æ¸¬
                        const groupStart = sequence.length - nextPos;
                        const observeBead = sequence[groupStart];
                        counterPred = [observeBead === 'B' ? 'P' : 'B'];
                    }
                }

                return {
                    bankerRate: ((bankerCount / sequence.length) * 100).toFixed(0),
                    playerRate: ((playerCount / sequence.length) * 100).toFixed(0),
                    followHits,
                    followTotal: followResults.length,
                    counterHits,
                    counterTotal: counterResults.length,
                    followPred,
                    counterPred,
                    followResults,
                    counterResults
                };
            }
            
            // å¾®ç¬‘è·¯ç‰¹æ®Šè™•ç†: çœ‹é€£å’Œè·³,æ¯ä¸€é¡†å’Œå‰ä¸€é¡†æ¯”è¼ƒ
            if (config && config.isSmilePath && sequence.length >= 1) {
                const bankerCount = sequence.filter(s => s === 'B').length;
                const playerCount = sequence.length - bankerCount;

                let followHits = 0;
                let counterHits = 0;
                const followResults = [];
                const counterResults = [];

                // å¾ç¬¬2é¡†é–‹å§‹,å’Œå‰ä¸€é¡†æ¯”è¼ƒ
                for (let i = 1; i < sequence.length; i++) {
                    const prev = sequence[i - 1];
                    const current = sequence[i];
                    
                    // æ‰“é€£: é æ¸¬å’Œå‰ä¸€é¡†ç›¸åŒ
                    const followHit = (prev === current);
                    followResults.push(followHit);
                    if (followHit) followHits++;
                    
                    // æ‰“è·³: é æ¸¬å’Œå‰ä¸€é¡†ä¸åŒ
                    const counterHit = (prev !== current);
                    counterResults.push(counterHit);
                    if (counterHit) counterHits++;
                }

                // è¨ˆç®—ä¸‹ä¸€é¡†æç¤º
                const last = sequence[sequence.length - 1];
                const followPred = [last]; // æ‰“é€£: é æ¸¬å’Œç•¶å‰ç›¸åŒ
                const counterPred = [last === 'B' ? 'P' : 'B']; // æ‰“è·³: é æ¸¬å’Œç•¶å‰ç›¸å

                return {
                    bankerRate: ((bankerCount / sequence.length) * 100).toFixed(0),
                    playerRate: ((playerCount / sequence.length) * 100).toFixed(0),
                    followHits,
                    followTotal: followResults.length,
                    counterHits,
                    counterTotal: counterResults.length,
                    followPred,
                    counterPred,
                    followResults,
                    counterResults
                };
            }
            
            // å·½éœ‡è·¯/å…Œè‰®è·¯/é›¢åè·¯ç‰¹æ®Šè™•ç†: å¾ªç’°é æ¸¬æ¨¡å¼,æ¯ä¸€é¡†éƒ½åˆ¤æ–·
            if (config && (config.isXunZhenRoad || config.isDuiGenRoad || config.isLiKanRoad) && sequence.length >= 1) {
                const bankerCount = sequence.filter(s => s === 'B').length;
                const playerCount = sequence.length - bankerCount;

                let followHits = 0;
                let counterHits = 0;
                const followResults = [];
                const counterResults = [];

                const pattern1 = config.patterns[0]; // æ­£æ‰“æ¨¡å¼ (ä¾‹å¦‚: 'BBP')
                const pattern2 = config.patterns[1]; // åæ‰“æ¨¡å¼ (ä¾‹å¦‚: 'PPB')

                // æ­£æ‰“æ¨¡å¼: ä¸€ç›´å¾ªç’°é æ¸¬ pattern1 (ä¾‹å¦‚ BBP BBP BBP...)
                let followExpecting = pattern1[0]; // é–‹å§‹é æ¸¬æ¨¡å¼çš„ç¬¬1å€‹å­—ç¬¦
                let followPos = 0; // ç•¶å‰åœ¨æ¨¡å¼ä¸­çš„ä½ç½®
                for (let i = 0; i < sequence.length; i++) {
                    const current = sequence[i];
                    const isHit = (current === followExpecting);
                    followResults.push(isHit);
                    if (isHit) followHits++;
                    
                    // ç„¡è«–å‘½ä¸­èˆ‡å¦,éƒ½ç§»åˆ°æ¨¡å¼çš„ä¸‹ä¸€å€‹ä½ç½®
                    followPos = (followPos + 1) % 3;
                    followExpecting = pattern1[followPos];
                }

                // åæ‰“æ¨¡å¼: ä¸€ç›´å¾ªç’°é æ¸¬ pattern2 (ä¾‹å¦‚ PPB PPB PPB...)
                let counterExpecting = pattern2[0]; // é–‹å§‹é æ¸¬æ¨¡å¼çš„ç¬¬1å€‹å­—ç¬¦
                let counterPos = 0; // ç•¶å‰åœ¨æ¨¡å¼ä¸­çš„ä½ç½®
                for (let i = 0; i < sequence.length; i++) {
                    const current = sequence[i];
                    const isHit = (current === counterExpecting);
                    counterResults.push(isHit);
                    if (isHit) counterHits++;
                    
                    // ç„¡è«–å‘½ä¸­èˆ‡å¦,éƒ½ç§»åˆ°æ¨¡å¼çš„ä¸‹ä¸€å€‹ä½ç½®
                    counterPos = (counterPos + 1) % 3;
                    counterExpecting = pattern2[counterPos];
                }

                // ä¸‹ä¸€é¡†çš„é æ¸¬ (å·²ç¶“åœ¨å¾ªç’°ä¸­æ›´æ–°äº†)
                const followPred = [followExpecting];
                const counterPred = [counterExpecting];

                return {
                    bankerRate: ((bankerCount / sequence.length) * 100).toFixed(0),
                    playerRate: ((playerCount / sequence.length) * 100).toFixed(0),
                    followHits,
                    followTotal: followResults.length,
                    counterHits,
                    counterTotal: counterResults.length,
                    followPred,
                    counterPred,
                    followResults,
                    counterResults
                };
            }
            
            // è·³æŠ•è·¯ç‰¹æ®Šè™•ç†: æ¯ä¸€é¡†éƒ½åˆ¤æ–·èŠé–’/é–’èŠæ¨¡å¼
            if (config && config.isJumpPath && sequence.length >= 1) {
                const bankerCount = sequence.filter(s => s === 'B').length;
                const playerCount = sequence.length - bankerCount;

                let followHits = 0;
                let counterHits = 0;
                const followResults = [];
                const counterResults = [];

                // èŠé–’æ¨¡å¼: ä¸€ç›´é æ¸¬ Bâ†’Pâ†’Bâ†’P å¾ªç’° (ä¸ç®¡ä¸­æˆ–ä¸ä¸­éƒ½è¼ªæµ)
                let followExpecting = 'B'; // é–‹å§‹é æ¸¬èŠ
                for (let i = 0; i < sequence.length; i++) {
                    const current = sequence[i];
                    const isHit = (current === followExpecting);
                    followResults.push(isHit);
                    if (isHit) followHits++;
                    
                    // ç„¡è«–å‘½ä¸­èˆ‡å¦,éƒ½åˆ‡æ›åˆ°ä¸‹ä¸€å€‹é æ¸¬å€¼
                    followExpecting = followExpecting === 'B' ? 'P' : 'B';
                }

                // é–’èŠæ¨¡å¼: ä¸€ç›´é æ¸¬ Pâ†’Bâ†’Pâ†’B å¾ªç’° (ä¸ç®¡ä¸­æˆ–ä¸ä¸­éƒ½è¼ªæµ)
                let counterExpecting = 'P'; // é–‹å§‹é æ¸¬é–’
                for (let i = 0; i < sequence.length; i++) {
                    const current = sequence[i];
                    const isHit = (current === counterExpecting);
                    counterResults.push(isHit);
                    if (isHit) counterHits++;
                    
                    // ç„¡è«–å‘½ä¸­èˆ‡å¦,éƒ½åˆ‡æ›åˆ°ä¸‹ä¸€å€‹é æ¸¬å€¼
                    counterExpecting = counterExpecting === 'P' ? 'B' : 'P';
                }

                const followPred = [followExpecting]; // èŠé–’ä¸‹ä¸€å€‹é æ¸¬
                const counterPred = [counterExpecting]; // é–’èŠä¸‹ä¸€å€‹é æ¸¬

                return {
                    bankerRate: ((bankerCount / sequence.length) * 100).toFixed(0),
                    playerRate: ((playerCount / sequence.length) * 100).toFixed(0),
                    followHits,
                    followTotal: followResults.length,
                    counterHits,
                    counterTotal: counterResults.length,
                    followPred,
                    counterPred,
                    followResults,
                    counterResults
                };
            }

            // ä¸€èˆ¬è·¯å–®éœ€è¦è‡³å°‘2çµ„
            if (groups.length < 2) {
                return {
                    bankerRate: 0,
                    playerRate: 0,
                    followHits: 0,
                    followTotal: 0,
                    counterHits: 0,
                    counterTotal: 0,
                    followPred: null,
                    counterPred: null,
                    followResults: [],
                    counterResults: []
                };
            }

            const bankerCount = groups.filter(g => g[g.length - 1] === 'B').length;
            const playerCount = groups.length - bankerCount;

            let followHits = 0;
            let counterHits = 0;
            const followResults = [];
            const counterResults = [];

            // è·³æŠ•è·¯ä½¿ç”¨ç‰¹æ®Šè¨ˆç®—é‚è¼¯
            if (config && config.isJumpPath) {
                // è·³æŠ•è·¯: èŠé–’ = BP, é–’èŠ = PB
                for (let i = 0; i < groups.length - 1; i++) {
                    const current = groups[i][groups[i].length - 1];
                    const next = groups[i + 1][groups[i + 1].length - 1];
                    
                    // èŠé–’: é æ¸¬ BP (èŠå¾Œé¢æ¥é–’)
                    const followHit = (current === 'B' && next === 'P');
                    if (followHit) followHits++;
                    followResults.push(followHit);
                    
                    // é–’èŠ: é æ¸¬ PB (é–’å¾Œé¢æ¥èŠ)
                    const counterHit = (current === 'P' && next === 'B');
                    if (counterHit) counterHits++;
                    counterResults.push(counterHit);
                }
            } else {
                // ä¸€èˆ¬è·¯å–®: æ­£æ‰“åæ‰“é‚è¼¯
                for (let i = 0; i < groups.length - 1; i++) {
                    const current = groups[i][groups[i].length - 1];
                    const next = groups[i + 1][groups[i + 1].length - 1];
                    
                    // æ­£æ‰“: é æ¸¬è·Ÿç•¶å‰ç›¸åŒ
                    const followHit = (current === next);
                    if (followHit) followHits++;
                    followResults.push(followHit);
                    
                    // åæ‰“: é æ¸¬è·Ÿç•¶å‰ç›¸å
                    const counterHit = (current !== next);
                    if (counterHit) counterHits++;
                    counterResults.push(counterHit);
                }
            }

            const last = groups[groups.length - 1];
            const lastResult = last[last.length - 1];
            const followPred = [...last.slice(1), lastResult];
            const counterPred = [...last.slice(1), lastResult === 'B' ? 'P' : 'B'];

            return {
                bankerRate: ((bankerCount / groups.length) * 100).toFixed(0),
                playerRate: ((playerCount / groups.length) * 100).toFixed(0),
                followHits,
                followTotal: groups.length - 1,
                counterHits,
                counterTotal: groups.length - 1,
                followPred,
                counterPred,
                followResults,
                counterResults
            };
        }

        // å‰µå»ºç©ºçš„ç å­æ ¼å­ (6è¡Œ10åˆ—,å·¦å´æœ‰è¡Œè™Ÿ1-6)
        function createEmptyStatBeads() {
            const container = document.createElement('div');
            const rows = 6;
            const cols = 10;
            
            const grid = document.createElement('div');
            grid.className = 'stat-beads-grid';
            grid.style.gridTemplateColumns = `18px repeat(${cols}, 24px)`;
            grid.style.gridTemplateRows = `repeat(${rows}, 24px)`;

            for (let row = 0; row < rows; row++) {
                // å·¦å´è¡Œè™Ÿ
                const rowLabel = document.createElement('div');
                rowLabel.className = 'stat-bead-cell stat-row-number';
                rowLabel.textContent = row + 1;
                grid.appendChild(rowLabel);

                // ç©ºæ ¼å­
                for (let col = 0; col < cols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'stat-bead-cell';
                    grid.appendChild(cell);
                }
            }

            container.appendChild(grid);
            return container;
        }

        // å‰µå»ºçµ±è¨ˆè¡Œçš„ç å­æ ¼å­ (6è¡ŒNåˆ—,å·¦å´æœ‰è¡Œè™Ÿ1-6)
        function createStatBeads(results, useRoadLogic = false) {
            const container = document.createElement('div');
            
            if (results.length === 0) {
                return createEmptyStatBeads();
            }

            const rows = 6; // å›ºå®š6è¡Œ
            
            // æ‰€æœ‰è·¯å–®éƒ½ä½¿ç”¨å¤§è·¯é‚è¼¯é¡¯ç¤º
            if (true) {
                // è·³æŠ•è·¯ç‰¹æ®Šé‚è¼¯: æŒ‰ç…§ç™¾å®¶æ¨‚å¤§è·¯æ–¹å¼é¡¯ç¤º
                const positions = [];
                let currentCol = 0;
                let currentRow = 0;
                let startCol = 0; // è¨˜éŒ„ç•¶å‰è·¯çš„èµ·å§‹åˆ—
                let dragonRow = -1; // è¨˜éŒ„é¾å°¾å»¶ä¼¸çš„å›ºå®šè¡Œæ•¸
                let prevHit = null;
                
                // è¼”åŠ©å‡½æ•¸: æª¢æŸ¥æŸå€‹ä½ç½®æ˜¯å¦å·²è¢«ä½”ç”¨
                const isOccupied = (col, row) => {
                    return positions.some(p => p.col === col && p.row === row);
                };
                
                for (let i = 0; i < results.length; i++) {
                    const isHit = results[i];
                    
                    // å¦‚æœç‹€æ…‹æ”¹è®Š,è·³åˆ°èµ·å§‹åˆ—çš„ä¸‹ä¸€åˆ—
                    if (prevHit !== null && prevHit !== isHit) {
                        currentCol = startCol + 1;
                        startCol = currentCol;
                        currentRow = 0;
                        dragonRow = -1; // é‡ç½®é¾å°¾è¡Œ
                    }
                    
                    // è¨˜éŒ„ç•¶å‰ç å­ä½ç½®
                    positions.push({ col: currentCol, row: currentRow, isHit });
                    
                    // è¨ˆç®—ä¸‹ä¸€é¡†ä½ç½®(å¦‚æœä¸æ˜¯æœ€å¾Œä¸€é¡†ä¸”ç‹€æ…‹ç›¸åŒ)
                    if (i < results.length - 1) {
                        const nextIsHit = results[i + 1];
                        if (nextIsHit === isHit) {
                            // å¦‚æœå·²ç¶“åœ¨é¾å°¾æ¨¡å¼,ç¹¼çºŒåœ¨é¾å°¾è¡Œå‘å³
                            if (dragonRow !== -1) {
                                currentCol++;
                                currentRow = dragonRow;
                                // å¦‚æœè¢«ä½”ç”¨ç¹¼çºŒå‘å³
                                while (isOccupied(currentCol, currentRow)) {
                                    currentCol++;
                                }
                            }
                            // å¦‚æœé‚„æ²’é€²å…¥é¾å°¾æ¨¡å¼
                            else if (currentRow < rows - 1 && !isOccupied(currentCol, currentRow + 1)) {
                                // é‚„æ²’åˆ°åº•éƒ¨ä¸”ä¸‹ä¸€è¡Œæ²’è¢«ä½”ç”¨:å¾€ä¸‹
                                currentRow++;
                            } else {
                                // åˆ°é”åº•éƒ¨æˆ–ä¸‹ä¸€è¡Œè¢«ä½”ç”¨:é€²å…¥é¾å°¾æ¨¡å¼
                                dragonRow = currentRow;
                                
                                // å‘å³ä¸¦åœ¨é¾å°¾è¡Œå»¶ä¼¸
                                currentCol++;
                                currentRow = dragonRow;
                                
                                // å¦‚æœè©²ä½ç½®è¢«ä½”ç”¨,ç¹¼çºŒå‘å³(ä¿æŒåŒä¸€è¡Œ)
                                while (isOccupied(currentCol, currentRow)) {
                                    currentCol++;
                                }
                            }
                        }
                    }
                    
                    prevHit = isHit;
                }
                
                // è¨ˆç®—éœ€è¦çš„åˆ—æ•¸
                const maxCol = Math.max(...positions.map(p => p.col));
                const cols = Math.max(maxCol + 1, 10); // è‡³å°‘10åˆ—
                
                const grid = document.createElement('div');
                grid.className = 'stat-beads-grid';
                grid.style.gridTemplateColumns = `18px repeat(${cols}, 24px)`;
                grid.style.gridTemplateRows = `repeat(${rows}, 24px)`;
                
                // 6è¡Œ
                for (let row = 0; row < rows; row++) {
                    // å·¦å´è¡Œè™Ÿ
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'stat-bead-cell stat-row-number';
                    rowLabel.textContent = row + 1;
                    grid.appendChild(rowLabel);
                    
                    // ç å­æ ¼å­
                    for (let col = 0; col < cols; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'stat-bead-cell';
                        
                        const pos = positions.find(p => p.col === col && p.row === row);
                        if (pos) {
                            const bead = document.createElement('div');
                            bead.className = pos.isHit ? 'stat-bead stat-bead-hit' : 'stat-bead stat-bead-miss';
                            bead.title = pos.isHit ? 'å‘½ä¸­' : 'æœªä¸­';
                            cell.appendChild(bead);
                        }
                        
                        grid.appendChild(cell);
                    }
                }
                
                container.appendChild(grid);
                return container;
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async function() {
            await checkLoginStatus();
            initializeEmptyRoads(); // åˆå§‹åŒ–é¡¯ç¤ºæ‰€æœ‰ç©ºè·¯å–®
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®š AIå±€æ•¸
            const savedAiStartRound = localStorage.getItem('aiStartRound');
            if (savedAiStartRound !== null) {
                document.getElementById('aiStartRound').value = savedAiStartRound;
                console.log('å·²è¼‰å…¥å„²å­˜çš„ AIå±€æ•¸:', savedAiStartRound);
            }
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®šé€£è·³æ¯”ç‡
            const savedJumpRatioThreshold = localStorage.getItem('jumpRatioThreshold');
            if (savedJumpRatioThreshold !== null) {
                document.getElementById('jumpRatioThreshold').value = savedJumpRatioThreshold;
                console.log('å·²è¼‰å…¥å„²å­˜çš„é€£è·³æ¯”ç‡:', savedJumpRatioThreshold);
            }
            
            // ç›£è½AIå±€æ•¸è¼¸å…¥æ¡†çš„è®ŠåŒ–,ç•¶å€¼æ”¹è®Šæ™‚é‡æ–°è¨ˆç®—
            const aiStartRoundInput = document.getElementById('aiStartRound');
            if (aiStartRoundInput) {
                let debounceTimer;
                let lastValue = aiStartRoundInput.value; // è¨˜éŒ„ä¸Šæ¬¡çš„å€¼
                
                // ä½¿ç”¨ input äº‹ä»¶ç«‹å³éŸ¿æ‡‰,ä¸¦æ·»åŠ é˜²æŠ–
                aiStartRoundInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºç™½,å¦‚æœæ˜¯å‰‡è¿”å›é è¨­å€¼ 12
                        if (aiStartRoundInput.value === '' || aiStartRoundInput.value === null) {
                            aiStartRoundInput.value = '12';
                            localStorage.setItem('aiStartRound', '12');
                            console.log('AIå±€æ•¸ç‚ºç©ºç™½,å·²æ¢å¾©é è¨­å€¼: 12');
                        }
                        // åªæœ‰å€¼çœŸçš„æ”¹è®Šäº†æ‰è™•ç†
                        if (aiStartRoundInput.value !== lastValue) {
                            lastValue = aiStartRoundInput.value;
                            // å„²å­˜åˆ° localStorage
                            localStorage.setItem('aiStartRound', aiStartRoundInput.value);
                            console.log('AIå±€æ•¸å·²è®Šæ›´ç‚º:', aiStartRoundInput.value, 'â†’ å·²å„²å­˜,ä¸æ¸…é™¤AIè¨˜éŒ„,åªé‡æ–°è¨ˆç®—æ­£ç¢ºç‡');
                            if (sequence.length > 0) {
                                analyzeAll();
                            }
                        }
                    }, 300); // 300ms é˜²æŠ–å»¶é²
                });
                
                // åŒæ™‚ä¿ç•™ change äº‹ä»¶,ç¢ºä¿å¤±å»ç„¦é»æ™‚ä¹Ÿæœƒæ›´æ–°
                aiStartRoundInput.addEventListener('change', function() {
                    clearTimeout(debounceTimer);
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºç™½,å¦‚æœæ˜¯å‰‡è¿”å›é è¨­å€¼ 12
                    if (aiStartRoundInput.value === '' || aiStartRoundInput.value === null) {
                        aiStartRoundInput.value = '12';
                        localStorage.setItem('aiStartRound', '12');
                        console.log('AIå±€æ•¸ç‚ºç©ºç™½,å·²æ¢å¾©é è¨­å€¼: 12 (bluräº‹ä»¶)');
                    }
                    if (aiStartRoundInput.value !== lastValue) {
                        lastValue = aiStartRoundInput.value;
                        // å„²å­˜åˆ° localStorage
                        localStorage.setItem('aiStartRound', aiStartRoundInput.value);
                        console.log('AIå±€æ•¸å·²è®Šæ›´ç‚º:', aiStartRoundInput.value, '(bluräº‹ä»¶) â†’ å·²å„²å­˜,ä¸æ¸…é™¤AIè¨˜éŒ„,åªé‡æ–°è¨ˆç®—æ­£ç¢ºç‡');
                        if (sequence.length > 0) {
                            analyzeAll();
                        }
                    }
                });
            }

            // ç›£è½é€£è·³æ¯”ç‡è¼¸å…¥æ¡†çš„è®ŠåŒ–,ç•¶å€¼æ”¹è®Šæ™‚é‡æ–°è¨ˆç®—
            const jumpRatioInput = document.getElementById('jumpRatioThreshold');
            if (jumpRatioInput) {
                jumpRatioInput.addEventListener('input', function() {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºç™½,å¦‚æœæ˜¯å‰‡è¿”å›é è¨­å€¼ 0.26
                    if (jumpRatioInput.value === '' || jumpRatioInput.value === null) {
                        jumpRatioInput.value = '0.26';
                        localStorage.setItem('jumpRatioThreshold', '0.26');
                        console.log('é€£è·³æ¯”ç‡ç‚ºç©ºç™½,å·²æ¢å¾©é è¨­å€¼: 0.26');
                    } else {
                        // å„²å­˜åˆ° localStorage
                        localStorage.setItem('jumpRatioThreshold', jumpRatioInput.value);
                        console.log('é€£è·³æ¯”ç‡é–¾å€¼å·²è®Šæ›´ç‚º:', jumpRatioInput.value, 'â†’ å·²å„²å­˜');
                    }
                    if (sequence.length > 0) {
                        analyzeAll(); // é‡æ–°è¨ˆç®—ä»¥æ›´æ–°è·³æ—º/é€£æ—ºåˆ¤æ–·
                    }
                });
                
                jumpRatioInput.addEventListener('change', function() {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºç™½,å¦‚æœæ˜¯å‰‡è¿”å›é è¨­å€¼ 0.26
                    if (jumpRatioInput.value === '' || jumpRatioInput.value === null) {
                        jumpRatioInput.value = '0.26';
                        localStorage.setItem('jumpRatioThreshold', '0.26');
                        console.log('é€£è·³æ¯”ç‡ç‚ºç©ºç™½,å·²æ¢å¾©é è¨­å€¼: 0.26 (bluräº‹ä»¶)');
                    } else {
                        // å„²å­˜åˆ° localStorage
                        localStorage.setItem('jumpRatioThreshold', jumpRatioInput.value);
                        console.log('é€£è·³æ¯”ç‡é–¾å€¼ç¢ºèªç‚º:', jumpRatioInput.value, 'â†’ å·²å„²å­˜');
                    }
                    if (sequence.length > 0) {
                        analyzeAll();
                    }
                });
            }
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®šé•·é¾é–¾å€¼
            const savedLongDragonThreshold = localStorage.getItem('longDragonThreshold');
            if (savedLongDragonThreshold !== null) {
                document.getElementById('longDragonThreshold').value = savedLongDragonThreshold;
                console.log('å·²è¼‰å…¥å„²å­˜çš„é•·é¾é–¾å€¼:', savedLongDragonThreshold);
            }
            
            // ç›£è½é•·é¾é–¾å€¼è®ŠåŒ–
            const longDragonInput = document.getElementById('longDragonThreshold');
            if (longDragonInput) {
                longDragonInput.addEventListener('change', function() {
                    if (longDragonInput.value === '' || longDragonInput.value === null) {
                        longDragonInput.value = '5';
                    }
                    // å…è¨±è¨­å®šç‚º 0ï¼ˆè¡¨ç¤ºåœç”¨åŠŸèƒ½ï¼‰
                    const value = parseInt(longDragonInput.value);
                    if (value < 0) {
                        longDragonInput.value = '0';
                    }
                    localStorage.setItem('longDragonThreshold', longDragonInput.value);
                    console.log('é•·é¾é–¾å€¼å·²è®Šæ›´ç‚º:', longDragonInput.value, value === 0 ? '(å·²åœç”¨)' : '', 'â†’ å·²å„²å­˜');
                    if (sequence.length > 0) {
                        analyzeAll();
                    }
                });
            }
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®šè·³é–¾å€¼
            const savedJumpPatternThreshold = localStorage.getItem('jumpPatternThreshold');
            if (savedJumpPatternThreshold !== null) {
                document.getElementById('jumpPatternThreshold').value = savedJumpPatternThreshold;
                console.log('å·²è¼‰å…¥å„²å­˜çš„è·³é–¾å€¼:', savedJumpPatternThreshold);
            }
            
            // ç›£è½è·³é–¾å€¼è®ŠåŒ–
            const jumpPatternInput = document.getElementById('jumpPatternThreshold');
            if (jumpPatternInput) {
                jumpPatternInput.addEventListener('change', function() {
                    if (jumpPatternInput.value === '' || jumpPatternInput.value === null) {
                        jumpPatternInput.value = '2';
                    }
                    // å…è¨±è¨­å®šç‚º 0ï¼ˆè¡¨ç¤ºåœç”¨åŠŸèƒ½ï¼‰
                    const value = parseInt(jumpPatternInput.value);
                    if (value < 0) {
                        jumpPatternInput.value = '0';
                    }
                    localStorage.setItem('jumpPatternThreshold', jumpPatternInput.value);
                    console.log('è·³é–¾å€¼å·²è®Šæ›´ç‚º:', jumpPatternInput.value, value === 0 ? '(å·²åœç”¨)' : '', 'â†’ å·²å„²å­˜');
                    if (sequence.length > 0) {
                        analyzeAll();
                    }
                });
            }
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®š AI è¨ˆç®—æ¨¡å¼
            const savedAiMode = localStorage.getItem('aiMode');
            if (savedAiMode === 'winRate') {
                document.getElementById('aiModeWinRate').checked = true;
                console.log('å·²è¼‰å…¥å„²å­˜çš„ AI æ¨¡å¼: å‹ç‡èŠé–’');
            } else {
                document.getElementById('aiModeVoteCount').checked = true;
                console.log('å·²è¼‰å…¥å„²å­˜çš„ AI æ¨¡å¼: ç¸½æ•¸èŠé–’');
            }
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®šå‹ç‡é–¾å€¼
            const savedWinRateThreshold = localStorage.getItem('winRateThreshold');
            if (savedWinRateThreshold !== null) {
                document.getElementById('winRateThreshold').value = savedWinRateThreshold;
                console.log('å·²è¼‰å…¥å„²å­˜çš„å‹ç‡é–¾å€¼:', savedWinRateThreshold + '%');
            }
            
            // ç›£è½å‹ç‡é–¾å€¼è®ŠåŒ–
            const winRateThresholdInput = document.getElementById('winRateThreshold');
            if (winRateThresholdInput) {
                winRateThresholdInput.addEventListener('change', function() {
                    let value = parseFloat(this.value);
                    if (isNaN(value) || value < 0) {
                        value = 0;
                        this.value = 0;
                    } else if (value > 100) {
                        value = 100;
                        this.value = 100;
                    }
                    localStorage.setItem('winRateThreshold', value);
                    console.log('å‹ç‡é–¾å€¼å·²è®Šæ›´ç‚º:', value + '% â†’ å·²å„²å­˜');
                    if (sequence.length > 0) {
                        analyzeAll();
                    }
                });
            }
            
            // ç›£è½ AI æ¨¡å¼è®ŠåŒ–
            const aiModeVoteCount = document.getElementById('aiModeVoteCount');
            const aiModeWinRate = document.getElementById('aiModeWinRate');
            
            if (aiModeVoteCount) {
                aiModeVoteCount.addEventListener('change', function() {
                    if (this.checked) {
                        localStorage.setItem('aiMode', 'voteCount');
                        console.log('AI æ¨¡å¼å·²åˆ‡æ›ç‚º: ç¸½æ•¸èŠé–’ â†’ å·²å„²å­˜');
                        if (sequence.length > 0) {
                            analyzeAll();
                        }
                    }
                });
            }
            
            if (aiModeWinRate) {
                aiModeWinRate.addEventListener('change', function() {
                    if (this.checked) {
                        localStorage.setItem('aiMode', 'winRate');
                        console.log('AI æ¨¡å¼å·²åˆ‡æ›ç‚º: å‹ç‡èŠé–’ â†’ å·²å„²å­˜');
                        if (sequence.length > 0) {
                            analyzeAll();
                        }
                    }
                });
            }
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®šè­¦ç¤ºé–‹é—œ
            const savedEnableWarnings = localStorage.getItem('enableWarnings');
            const enableWarningsCheckbox = document.getElementById('enableWarnings');
            if (enableWarningsCheckbox) {
                if (savedEnableWarnings !== null) {
                    enableWarningsCheckbox.checked = savedEnableWarnings === 'true';
                    console.log('å·²è¼‰å…¥å„²å­˜çš„è­¦ç¤ºè¨­å®š:', savedEnableWarnings);
                }
                
                // ç›£è½è­¦ç¤ºé–‹é—œçš„è®ŠåŒ–
                enableWarningsCheckbox.addEventListener('change', function() {
                    localStorage.setItem('enableWarnings', enableWarningsCheckbox.checked);
                    console.log('è­¦ç¤ºåŠŸèƒ½å·²', enableWarningsCheckbox.checked ? 'å•Ÿç”¨' : 'é—œé–‰', 'â†’ å·²å„²å­˜');
                    
                    // é‡æ–°åˆ†æä»¥æ›´æ–°è­¦ç¤ºé¡¯ç¤º
                    if (sequence.length > 0) {
                        analyzeAll();
                    }
                });
            }
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®š AIçµ±è¨ˆé¡¯ç¤ºé–‹é—œ
            const savedShowAiStreakCount = localStorage.getItem('showAiStreakCount');
            const showAiStreakCountCheckbox = document.getElementById('showAiStreakCount');
            const aiStreakCountItem = document.getElementById('aiStreakCountItem');
            
            if (showAiStreakCountCheckbox) {
                if (savedShowAiStreakCount !== null) {
                    showAiStreakCountCheckbox.checked = savedShowAiStreakCount === 'true';
                    console.log('å·²è¼‰å…¥å„²å­˜çš„ AIçµ±è¨ˆé¡¯ç¤ºè¨­å®š:', savedShowAiStreakCount);
                }
                
                // è¨­å®šåˆå§‹é¡¯ç¤ºç‹€æ…‹
                if (aiStreakCountItem) {
                    aiStreakCountItem.style.display = showAiStreakCountCheckbox.checked ? 'flex' : 'none';
                }
                
                // ç›£è½ AIçµ±è¨ˆé¡¯ç¤ºé–‹é—œçš„è®ŠåŒ–
                showAiStreakCountCheckbox.addEventListener('change', function() {
                    localStorage.setItem('showAiStreakCount', showAiStreakCountCheckbox.checked);
                    console.log('AIçµ±è¨ˆé¡¯ç¤ºå·²', showAiStreakCountCheckbox.checked ? 'å•Ÿç”¨' : 'é—œé–‰', 'â†’ å·²å„²å­˜');
                    
                    // æ›´æ–°é¡¯ç¤ºç‹€æ…‹
                    if (aiStreakCountItem) {
                        aiStreakCountItem.style.display = showAiStreakCountCheckbox.checked ? 'flex' : 'none';
                    }
                });
            }
            
            // å¾ localStorage è®€å–ä¸¦è¨­å®šè·³é€£æ¯”ç‡é¡¯ç¤ºé–‹é—œ
            const savedShowJumpRatio = localStorage.getItem('showJumpRatio');
            const showJumpRatioCheckbox = document.getElementById('showJumpRatio');
            const jumpRatioItem = document.getElementById('jumpRatioItem');
            
            if (showJumpRatioCheckbox) {
                if (savedShowJumpRatio !== null) {
                    showJumpRatioCheckbox.checked = savedShowJumpRatio === 'true';
                    console.log('å·²è¼‰å…¥å„²å­˜çš„è·³é€£æ¯”ç‡é¡¯ç¤ºè¨­å®š:', savedShowJumpRatio);
                }
                
                // è¨­å®šåˆå§‹é¡¯ç¤ºç‹€æ…‹
                if (jumpRatioItem) {
                    jumpRatioItem.style.display = showJumpRatioCheckbox.checked ? 'flex' : 'none';
                }
                
                // ç›£è½è·³é€£æ¯”ç‡é¡¯ç¤ºé–‹é—œçš„è®ŠåŒ–
                showJumpRatioCheckbox.addEventListener('change', function() {
                    localStorage.setItem('showJumpRatio', showJumpRatioCheckbox.checked);
                    console.log('è·³é€£æ¯”ç‡é¡¯ç¤ºå·²', showJumpRatioCheckbox.checked ? 'å•Ÿç”¨' : 'é—œé–‰', 'â†’ å·²å„²å­˜');
                    
                    // æ›´æ–°é¡¯ç¤ºç‹€æ…‹
                    if (jumpRatioItem) {
                        jumpRatioItem.style.display = showJumpRatioCheckbox.checked ? 'flex' : 'none';
                    }
                });
            }
        });

        // ============ æ›²ç·šåœ–åŠŸèƒ½ ============
        let chartInstance = null;

        // å››æ¨äº”å…¥åˆ°æŒ‡å®šå°æ•¸ä½
        function roundToDecimal(value, decimals) {
            return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);
        }

        // è¨ˆç®—è·³é€£æ¯”ç‡
        function calculateJumpRatio(results, index) {
            if (index === 0) return 0;
            
            const groups = [];
            let currentGroup = { value: results[0], count: 1 };
            
            for (let i = 1; i <= index; i++) {
                if (results[i] === currentGroup.value) {
                    currentGroup.count++;
                } else {
                    groups.push(currentGroup);
                    currentGroup = { value: results[i], count: 1 };
                }
            }
            groups.push(currentGroup);
            
            let singleJumps = 0;
            for (const group of groups) {
                if (group.count === 1) {
                    singleJumps++;
                }
            }
            
            const total = index + 1;
            return total > 0 ? roundToDecimal(singleJumps / total, 2) : 0;
        }

        // è¨ˆç®—ç´¯ç©å‹ç‡
        function calculateWinRates(results) {
            let bankerCount = 0;
            let playerCount = 0;
            const data = [];

            for (let i = 0; i < results.length; i++) {
                const result = results[i];
                
                if (result === 'B') {
                    bankerCount++;
                } else if (result === 'P') {
                    playerCount++;
                }

                const total = bankerCount + playerCount;
                const bankerWinRate = total > 0 ? roundToDecimal(bankerCount / total, 2) : 0;
                const playerWinRate = total > 0 ? roundToDecimal(playerCount / total, 2) : 0;
                const jumpRatio = calculateJumpRatio(results, i);

                data.push({
                    index: i,
                    result: result,
                    bankerCount: bankerCount,
                    playerCount: playerCount,
                    total: total,
                    bankerWinRate: bankerWinRate,
                    playerWinRate: playerWinRate,
                    jumpRatio: jumpRatio
                });
            }

            return data;
        }

        // æ‰“é–‹æ›²ç·šåœ–æ¨¡æ…‹è¦–çª—
        function openChartModal() {
            const modal = document.getElementById('chartModal');
            modal.style.display = 'block';
            
            // ç¹ªè£½åœ–è¡¨ï¼ˆå³ä½¿æ²’æœ‰æ•¸æ“šä¹Ÿå¯ä»¥æ‰“é–‹ï¼‰
            if (sequence.length > 0) {
                drawChartInModal();
            } else {
                // æ¸…ç©ºåœ–è¡¨å’Œæ•¸æ“šè¡¨
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
                document.getElementById('chartDataTableBody').innerHTML = '<tr><td colspan="8" style="padding: 20px; color: #999;">å°šç„¡æ•¸æ“š</td></tr>';
            }
        }

        // é—œé–‰æ›²ç·šåœ–æ¨¡æ…‹è¦–çª—
        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            modal.style.display = 'none';
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        // å¡«å……æ•¸æ“šè¡¨
        function fillDataTable(data) {
            const tbody = document.getElementById('chartDataTableBody');
            tbody.innerHTML = '';

            data.forEach(d => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${d.index + 1}</td>
                    <td><strong class="${d.result === 'B' ? 'result-b' : 'result-p'}">${d.result}</strong></td>
                    <td>${d.bankerCount}</td>
                    <td>${d.playerCount}</td>
                    <td>${d.total}</td>
                    <td><strong>${d.bankerWinRate.toFixed(2)}</strong></td>
                    <td><strong>${d.playerWinRate.toFixed(2)}</strong></td>
                    <td><strong>${d.jumpRatio.toFixed(2)}</strong></td>
                `;
            });
        }

        // åœ¨æ¨¡æ…‹è¦–çª—ä¸­ç¹ªè£½åœ–è¡¨
        function drawChartInModal() {
            const data = calculateWinRates(sequence);
            const ctx = document.getElementById('chartCanvas');
            
            // å¡«å……æ•¸æ“šè¡¨
            fillDataTable(data);
            
            const showBanker = document.getElementById('chartShowBanker').checked;
            const showPlayer = document.getElementById('chartShowPlayer').checked;
            const showPlayerIndex = document.getElementById('chartShowPlayerIndex').checked;
            const showJumpRatio = document.getElementById('chartShowJumpRatio').checked;
            const showValues = document.getElementById('chartShowValues').checked;
            const showPoints = document.getElementById('chartShowPoints').checked;
            const showGrid = document.getElementById('chartShowGrid').checked;

            if (chartInstance) {
                chartInstance.destroy();
            }

            const datasets = [];
            const pointRadius = showPoints ? 3 : 0;

            if (showBanker) {
                datasets.push({
                    label: 'èŠæ¯”ç‡',
                    data: data.map(d => ({ x: d.index + 1, y: d.bankerWinRate })),
                    borderColor: 'rgb(255, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0.1)',
                    borderWidth: 2,
                    pointRadius: pointRadius,
                    pointHoverRadius: 5,
                    tension: 0.1
                });
            }

            if (showPlayer) {
                datasets.push({
                    label: 'é–’æ¯”ç‡',
                    data: data.map(d => ({ x: d.index + 1, y: d.playerWinRate })),
                    borderColor: 'rgb(0, 102, 255)',
                    backgroundColor: 'rgba(0, 102, 255, 0.1)',
                    borderWidth: 2,
                    pointRadius: pointRadius,
                    pointHoverRadius: 5,
                    tension: 0.1
                });
            }

            if (showPlayerIndex) {
                datasets.push({
                    label: 'é–’å‹æŒ‡æ•¸',
                    data: data.map(d => ({ x: d.index + 1, y: 0.5 })),
                    borderColor: 'rgb(0, 200, 100)',
                    backgroundColor: 'rgba(0, 200, 100, 0)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    tension: 0
                });
                datasets.push({
                    label: '_é–’å‹æŒ‡æ•¸_0.26',
                    data: data.map(d => ({ x: d.index + 1, y: 0.26 })),
                    borderColor: 'rgb(0, 200, 100)',
                    backgroundColor: 'rgba(0, 200, 100, 0)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    tension: 0
                });
            }

            if (showJumpRatio) {
                datasets.push({
                    label: 'è·³é€£æ¯”ç‡',
                    data: data.map(d => ({ x: d.index + 1, y: d.jumpRatio })),
                    borderColor: 'rgb(255, 140, 0)',
                    backgroundColor: 'rgba(255, 140, 0, 0.1)',
                    borderWidth: 2,
                    pointRadius: pointRadius,
                    pointHoverRadius: 5,
                    tension: 0.1
                });
            }

            // æª¢æ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿ
            const isMobile = window.innerWidth <= 768;

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: !isMobile,
                    aspectRatio: isMobile ? 1 : 2,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ç™¾å®¶æ¨‚ç´¯ç©å‹ç‡æ›²ç·šåœ–',
                            font: { size: isMobile ? 14 : 18, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { 
                                font: { size: isMobile ? 10 : 14 },
                                padding: isMobile ? 8 : 10,
                                boxWidth: isMobile ? 25 : 40,
                                filter: function(item) {
                                    return !item.text.startsWith('_');
                                }
                            }
                        },
                        datalabels: {
                            display: showValues && !isMobile,
                            align: 'top',
                            anchor: 'end',
                            font: {
                                size: 10,
                                weight: 'bold'
                            },
                            formatter: function(value) {
                                return value.y.toFixed(2);
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = data[context.parsed.x - 1];
                                    if (!d) return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                    return [
                                        context.dataset.label + ': ' + context.parsed.y.toFixed(2),
                                        'ç¬¬' + (d.index + 1) + 'å±€: ' + d.result,
                                        'èŠ:' + d.bankerCount + ' é–’:' + d.playerCount,
                                        'è·³é€£æ¯”ç‡: ' + d.jumpRatio.toFixed(2)
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            min: 0,
                            max: Math.max(data.length, 21),
                            title: {
                                display: true,
                                text: 'å±€æ•¸',
                                font: { size: isMobile ? 11 : 14, weight: 'bold' }
                            },
                            ticks: {
                                stepSize: isMobile ? 5 : 1,
                                font: { size: isMobile ? 9 : 11 },
                                callback: function(value) {
                                    return Number.isInteger(value) && value >= 0 ? value : '';
                                }
                            },
                            grid: {
                                display: showGrid,
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            min: 0,
                            max: 1,
                            title: {
                                display: true,
                                text: 'æ¯”ç‡',
                                font: { size: isMobile ? 11 : 14, weight: 'bold' }
                            },
                            ticks: {
                                stepSize: 0.1,
                                font: { size: isMobile ? 9 : 11 },
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            },
                            grid: {
                                display: showGrid,
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // é»æ“Šæ¨¡æ…‹è¦–çª—å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('chartModal');
            if (event.target === modal) {
                closeChartModal();
            }
        }
    </script>

    <!-- æ›²ç·šåœ–æ¨¡æ…‹è¦–çª— -->
    <div id="chartModal" class="chart-modal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h2><i class="fas fa-chart-line"></i> ç™¾å®¶æ¨‚ç´¯ç©å‹ç‡æ›²ç·šåœ–</h2>
                <span class="chart-close" onclick="closeChartModal()">&times;</span>
            </div>

            <div class="chart-options">
                <label class="chart-checkbox-label">
                    <input type="checkbox" id="chartShowBanker" checked onchange="drawChartInModal()">
                    <span>èŠæ¯”ç‡</span>
                </label>
                <label class="chart-checkbox-label">
                    <input type="checkbox" id="chartShowPlayer" checked onchange="drawChartInModal()">
                    <span>é–’æ¯”ç‡</span>
                </label>
                <label class="chart-checkbox-label">
                    <input type="checkbox" id="chartShowPlayerIndex" onchange="drawChartInModal()">
                    <span>é–’å‹æŒ‡æ•¸</span>
                </label>
                <label class="chart-checkbox-label">
                    <input type="checkbox" id="chartShowJumpRatio" onchange="drawChartInModal()">
                    <span>è·³é€£æ¯”ç‡</span>
                </label>
                <label class="chart-checkbox-label">
                    <input type="checkbox" id="chartShowValues" checked onchange="drawChartInModal()">
                    <span>é¡¯ç¤ºæ•¸å€¼</span>
                </label>
                <label class="chart-checkbox-label">
                    <input type="checkbox" id="chartShowPoints" checked onchange="drawChartInModal()">
                    <span>é¡¯ç¤ºç¯€é»</span>
                </label>
                <label class="chart-checkbox-label">
                    <input type="checkbox" id="chartShowGrid" checked onchange="drawChartInModal()">
                    <span>é¡¯ç¤ºç¶²æ ¼</span>
                </label>
            </div>

            <div style="background: #fff3cd; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                <div style="color: #856404; font-size: 13px; line-height: 1.6;">
                    <strong><i class="fas fa-info-circle"></i> è·³é€£æ¯”ç‡èªªæ˜ï¼š</strong><br>
                    <span style="color: #2ed573; font-weight: bold;">â–² é«˜æ–¼ 0.26</span> = è·³æ—ºï¼ˆå–®è·³è¼ƒå¤šï¼Œå»ºè­°è·Ÿè·³ï¼‰<br>
                    <span style="color: #ff6348; font-weight: bold;">â–¼ ä½æ–¼ 0.26</span> = é€£æ—ºï¼ˆé€£é–‹è¼ƒå¤šï¼Œå»ºè­°è·Ÿé€£ï¼‰
                </div>
            </div>

            <div class="chart-canvas-container">
                <canvas id="chartCanvas"></canvas>
            </div>

            <div class="chart-data-table">
                <h3><i class="fas fa-table"></i> è©³ç´°æ•¸æ“šè¡¨</h3>
                <div class="chart-data-table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th><span class="desktop-only">å±€æ•¸</span><span class="mobile-only">å±€</span></th>
                                <th>çµæœ</th>
                                <th><span class="desktop-only">èŠç´¯è¨ˆ</span><span class="mobile-only">èŠ</span></th>
                                <th><span class="desktop-only">é–’ç´¯è¨ˆ</span><span class="mobile-only">é–’</span></th>
                                <th><span class="desktop-only">ç¸½å±€æ•¸</span><span class="mobile-only">ç¸½</span></th>
                                <th><span class="desktop-only">èŠæ¯”ç‡</span><span class="mobile-only">èŠç‡</span></th>
                                <th><span class="desktop-only">é–’æ¯”ç‡</span><span class="mobile-only">é–’ç‡</span></th>
                                <th><span class="desktop-only">è·³é€£æ¯”ç‡</span><span class="mobile-only">è·³é€£</span></th>
                            </tr>
                        </thead>
                        <tbody id="chartDataTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div><!-- é–‰åˆ mainApp -->

    <script>
        // ===== æ¿€æ´»ç¢¼ç³»çµ± =====
        let deviceId = '';

        // ç”Ÿæˆè¨­å‚™ID (é‚€è«‹ç¢¼)
        function generateDeviceId() {
            // å˜—è©¦å¾å¤šå€‹ä¾†æºç”Ÿæˆå”¯ä¸€ID
            const sources = [
                navigator.userAgent,
                navigator.language,
                navigator.platform,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                navigator.hardwareConcurrency || 'unknown',
                navigator.deviceMemory || 'unknown'
            ];
            
            const fingerprint = sources.join('|');
            
            // ä½¿ç”¨ç°¡å–®çš„å“ˆå¸Œç®—æ³•ç”Ÿæˆè¨­å‚™ID
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            // è½‰æ›ç‚º16é€²åˆ¶ä¸¦è£œè¶³é•·åº¦
            const hexHash = Math.abs(hash).toString(16).padStart(8, '0');
            const timestamp = Date.now().toString(36).substring(0, 8);
            
            return (hexHash + timestamp).substring(0, 16).toLowerCase();
        }

        // SHA-256 ç®—æ³• (è¿”å›å­—ç¯€æ•¸çµ„)
        async function sha256Bytes(input) {
            let msgBuffer;
            if (typeof input === 'string') {
                msgBuffer = new TextEncoder().encode(input);
            } else {
                msgBuffer = input;
            }
            return await crypto.subtle.digest('SHA-256', msgBuffer);
        }

        // ç”Ÿæˆæ¿€æ´»ç¢¼ (èˆ‡ activation.html å®Œå…¨ç›¸åŒçš„ç®—æ³•)
        async function generateActivationCode(deviceId) {
            // ç¬¬ä¸€æ­¥: deviceId + "FUMU_2025" + deviceIdé•·åº¦
            const text = deviceId + 'FUMU_2025' + deviceId.length;
            
            // ç¬¬äºŒæ­¥: SHA-256ä¸‰æ¬¡è¿­ä»£
            let hashBytes = await sha256Bytes(text);
            hashBytes = await sha256Bytes(hashBytes);
            hashBytes = await sha256Bytes(hashBytes);
            
            // ç¬¬ä¸‰æ­¥: è½‰æ›ç‚ºåå…­é€²åˆ¶å­—ç¬¦ä¸²
            const hashArray = Array.from(new Uint8Array(hashBytes));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            // ç¬¬å››æ­¥: å–å‰12ä½ä¸¦è½‰å¤§å¯«
            return hashHex.substring(0, 12).toUpperCase();
        }

        // é©—è­‰æ¿€æ´»ç¢¼
        async function verifyActivationCode(deviceId, inputCode) {
            const correctCode = await generateActivationCode(deviceId);
            return inputCode.toUpperCase().trim() === correctCode;
        }

        // è¤‡è£½è¨­å‚™ID
        function copyDeviceId() {
            const deviceIdText = document.getElementById('deviceIdDisplay').textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(deviceIdText).then(() => {
                    // éœé»˜è¤‡è£½,ä¸é¡¯ç¤ºå½ˆçª—
                }).catch(() => {
                    fallbackCopy(deviceIdText);
                });
            } else {
                fallbackCopy(deviceIdText);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                // éœé»˜è¤‡è£½,ä¸é¡¯ç¤ºå½ˆçª—
            } catch (err) {
                // éœé»˜å¤±æ•—,ä¸é¡¯ç¤ºå½ˆçª—
            }
            document.body.removeChild(textarea);
        }

        // æ¿€æ´»æ‡‰ç”¨
        async function activateApp() {
            const inputCode = document.getElementById('activationCodeInput').value.trim();
            const messageDiv = document.getElementById('activationMessage');
            
            if (!inputCode) {
                messageDiv.innerHTML = '<div class="activation-error"><i class="fas fa-exclamation-circle"></i> è«‹è¼¸å…¥æ¿€æ´»ç¢¼!</div>';
                return;
            }
            
            if (inputCode.length !== 12) {
                messageDiv.innerHTML = '<div class="activation-error"><i class="fas fa-exclamation-circle"></i> æ¿€æ´»ç¢¼æ ¼å¼éŒ¯èª¤! æ‡‰ç‚º12ä½å­—ç¬¦</div>';
                return;
            }
            
            // é©—è­‰æ¿€æ´»ç¢¼
            const isValid = await verifyActivationCode(deviceId, inputCode);
            
            if (isValid) {
                // æ¿€æ´»æˆåŠŸ
                messageDiv.innerHTML = '<div class="activation-success"><i class="fas fa-check-circle"></i> æ¿€æ´»æˆåŠŸ! æ­£åœ¨é€²å…¥ç³»çµ±...</div>';
                
                // ä¿å­˜æ¿€æ´»ç‹€æ…‹
                localStorage.setItem('fumu_activated', 'true');
                localStorage.setItem('fumu_device_id', deviceId);
                localStorage.setItem('fumu_activation_code', inputCode.toUpperCase());
                localStorage.setItem('fumu_activation_date', new Date().toISOString());
                
                // å»¶é²é€²å…¥ä¸»æ‡‰ç”¨
                setTimeout(() => {
                    document.body.classList.add('activated');
                }, 1000);
            } else {
                // æ¿€æ´»å¤±æ•—
                messageDiv.innerHTML = '<div class="activation-error"><i class="fas fa-times-circle"></i> æ¿€æ´»ç¢¼éŒ¯èª¤! è«‹æª¢æŸ¥å¾Œé‡è©¦</div>';
                document.getElementById('activationCodeInput').value = '';
                document.getElementById('activationCodeInput').focus();
            }
        }

        // æª¢æŸ¥æ¿€æ´»ç‹€æ…‹
        function checkActivationStatus() {
            const isActivated = localStorage.getItem('fumu_activated') === 'true';
            const savedDeviceId = localStorage.getItem('fumu_device_id');
            
            // ç”Ÿæˆæˆ–ä½¿ç”¨å·²ä¿å­˜çš„è¨­å‚™ID
            if (savedDeviceId) {
                deviceId = savedDeviceId;
            } else {
                deviceId = generateDeviceId();
                localStorage.setItem('fumu_device_id', deviceId);
            }
            
            // é¡¯ç¤ºè¨­å‚™ID
            document.getElementById('deviceIdDisplay').textContent = deviceId;
            
            // å¦‚æœå·²æ¿€æ´»ï¼Œç›´æ¥é€²å…¥ä¸»æ‡‰ç”¨
            if (isActivated) {
                document.body.classList.add('activated');
            }
        }

        // Enteréµå¿«æ·æ¿€æ´»
        document.addEventListener('DOMContentLoaded', function() {
            checkActivationStatus();
            
            const activationInput = document.getElementById('activationCodeInput');
            if (activationInput) {
                activationInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        activateApp();
                    }
                });
            }
        });
    </script>
</body>
</html>
